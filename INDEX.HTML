 (cd "$(git rev-parse --show-toplevel)" && git apply --3way <<'EOF' 
diff --git a/index.html b/index.html
index a0fe2a424074ce7002ca51e9862f2e2a8831370d..81e8c7d82749cb4d397c2166e98f78ccb92a249d 100644
--- a/index.html
+++ b/index.html
@@ -1,206 +1,945 @@
- <!DOCTYPE html>
-<html>
-<head>
-    <title>Route Tracker</title>
-    <meta name="viewport" content="width=device-width, initial-scale=1">
+<!DOCTYPE html>
+<html lang="en">
+  <head>
+    <meta charset="utf-8" />
+    <meta name="viewport" content="width=device-width, initial-scale=1" />
+    <title>Draftbit Tour Navigator</title>
     <style>
-        body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
-        #map { height: 100vh; width: 100%; }
-        .info-panel {
-            position: absolute;
-            top: 10px;
-            left: 10px;
-            background: rgba(255, 255, 255, 0.95);
-            padding: 15px;
-            border-radius: 8px;
-            font-size: 14px;
-            max-width: 250px;
-            z-index: 1000;
-            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
-        }
-        .status { margin-top: 10px; color: #666; font-size: 12px; }
-        .button {
-            background: #1E90FF;
-            color: white;
-            border: none;
-            padding: 8px 12px;
-            border-radius: 4px;
-            cursor: pointer;
-            margin: 5px 5px 5px 0;
-            font-size: 12px;
-        }
-        .button:hover { background: #0080FF; }
+      :root {
+        color-scheme: light dark;
+      }
+
+      html,
+      body {
+        height: 100%;
+        margin: 0;
+        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
+        background: #f8f9fa;
+        color: #111827;
+      }
+
+      #map {
+        position: absolute;
+        inset: 0;
+        width: 100%;
+        height: 100%;
+      }
+
+      .controls {
+        position: absolute;
+        left: 12px;
+        right: 12px;
+        bottom: 12px;
+        margin: 0 auto;
+        max-width: 460px;
+        padding: 12px 14px;
+        border-radius: 10px;
+        background: rgba(255, 255, 255, 0.95);
+        box-shadow: 0 8px 24px rgba(15, 23, 42, 0.12);
+        display: flex;
+        flex-direction: column;
+        gap: 10px;
+      }
+
+      .controls .row {
+        display: flex;
+        flex-direction: column;
+        gap: 4px;
+      }
+
+      .controls .label {
+        font-size: 12px;
+        letter-spacing: 0.08em;
+        text-transform: uppercase;
+        color: #6b7280;
+      }
+
+      .controls .value {
+        font-weight: 600;
+        font-size: 15px;
+      }
+
+      .controls select,
+      .controls button {
+        font: inherit;
+        padding: 8px 10px;
+        border-radius: 6px;
+        border: 1px solid #d1d5db;
+        background: #ffffff;
+      }
+
+      .controls select:focus,
+      .controls button:focus {
+        outline: 2px solid #2563eb;
+        outline-offset: 2px;
+      }
+
+      .controls button {
+        border: none;
+        font-weight: 600;
+        cursor: pointer;
+        color: #ffffff;
+        background: #2563eb;
+      }
+
+      .controls button:disabled {
+        opacity: 0.6;
+        cursor: not-allowed;
+      }
+
+      .controls .buttons {
+        display: flex;
+        gap: 8px;
+      }
+
+      .controls .buttons button {
+        flex: 1;
+        min-width: 120px;
+      }
+
+      .notes {
+        font-size: 13px;
+        color: #4b5563;
+        white-space: pre-line;
+      }
+
+      .metrics {
+        display: flex;
+        align-items: center;
+        gap: 8px;
+        font-size: 14px;
+        color: #1f2937;
+      }
+
+      .status {
+        font-size: 13px;
+        color: #374151;
+        min-height: 18px;
+      }
+
+      @media (min-width: 640px) {
+        .controls {
+          left: 16px;
+          right: auto;
+        }
+      }
     </style>
-</head>
-<body>
-    <div id="map"></div>
-    
-    <div class="info-panel">
-        <strong>Route: E 12th St → S Santa Fe Ave</strong><br>
-        Distance: <span id="distance">0.9 mi</span><br>
-        Duration: <span id="duration">4 mins</span><br>
-        <div class="status" id="location-status">Waiting for location from Draftbit...</div>
-        <button class="button" onclick="showRoute()">Refresh Route</button>
-    </div>
+  </head>
+  <body>
+    <div id="map" role="application" aria-label="Tour map"></div>
+    <section class="controls" aria-live="polite">
+      <div class="row">
+        <div class="label">Tour</div>
+        <div id="tour-name" class="value">Loading…</div>
+      </div>
+      <div class="row" id="tour-select-row" style="display: none;">
+        <label class="label" for="tour-select">Switch tour</label>
+        <select id="tour-select"></select>
+      </div>
+      <div class="row">
+        <div class="label">Stop</div>
+        <div id="stop-name" class="value">—</div>
+        <div id="stop-notes" class="notes" style="display: none;"></div>
+      </div>
+      <div class="row metrics">
+        <span id="distance">—</span>
+        <span aria-hidden="true">•</span>
+        <span id="duration">—</span>
+      </div>
+      <div id="status" class="status">Waiting for tours…</div>
+      <div class="buttons">
+        <button id="start-btn" type="button">Start tour</button>
+        <button id="next-btn" type="button" disabled>Next stop</button>
+      </div>
+    </section>
 
     <script>
-        let map;
-        let directionsService;
-        let directionsRenderer;
-        let userMarker;
+      (function () {
+        const fallbackTours = [
+          {
+            id: "historic-dtla",
+            name: "Historic Downtown LA",
+            description: "Sample tour used until your data source provides tours.",
+            stops: [
+              {
+                id: "union-station",
+                name: "Union Station",
+                description: "Iconic 1939 station and transit hub.",
+                address: "800 N Alameda St, Los Angeles, CA",
+                lat: 34.056272,
+                lng: -118.236502,
+              },
+              {
+                id: "olvera-street",
+                name: "Olvera Street",
+                description: "Historic marketplace celebrating Mexican culture.",
+                address: "845 N Alameda St, Los Angeles, CA",
+                lat: 34.056219,
+                lng: -118.237358,
+              },
+              {
+                id: "bradbury-building",
+                name: "Bradbury Building",
+                description: "Landmark 1893 office building with ornate atrium.",
+                address: "304 S Broadway, Los Angeles, CA",
+                lat: 34.050536,
+                lng: -118.247861,
+              },
+            ],
+          },
+          {
+            id: "arts-district",
+            name: "Arts District Highlights",
+            description: "Street art, cafes and creative spaces in DTLA.",
+            stops: [
+              {
+                id: "hauser-wirth",
+                name: "Hauser & Wirth",
+                description: "Gallery & community arts space.",
+                address: "901 E 3rd St, Los Angeles, CA",
+                lat: 34.044947,
+                lng: -118.236106,
+              },
+              {
+                id: "salt-creamery",
+                name: "Salt & Straw",
+                description: "Small-batch ice cream with unique flavors.",
+                address: "829 E 3rd St, Los Angeles, CA",
+                lat: 34.044786,
+                lng: -118.234912,
+              },
+              {
+                id: "angel-city",
+                name: "Angel City Brewery",
+                description: "Craft brewery with a spacious taproom.",
+                address: "216 Alameda St, Los Angeles, CA",
+                lat: 34.044132,
+                lng: -118.237947,
+              },
+            ],
+          },
+        ];
 
-        // Route coordinates
-        const startPoint = { lat: 34.0225823, lng: -118.2274002 };
-        const endPoint = { lat: 34.0134287, lng: -118.2296891 };
+        const elements = {
+          tourName: document.getElementById("tour-name"),
+          tourSelectRow: document.getElementById("tour-select-row"),
+          tourSelect: document.getElementById("tour-select"),
+          stopName: document.getElementById("stop-name"),
+          stopNotes: document.getElementById("stop-notes"),
+          distance: document.getElementById("distance"),
+          duration: document.getElementById("duration"),
+          status: document.getElementById("status"),
+          startButton: document.getElementById("start-btn"),
+          nextButton: document.getElementById("next-btn"),
+        };
 
-        function initMap() {
-            console.log('Initializing map...');
-            
-            // Initialize map
-            map = new google.maps.Map(document.getElementById("map"), {
-                zoom: 14,
-                center: { lat: 34.0177, lng: -118.2289 },
-                mapTypeId: "roadmap",
+        const state = {
+          tours: [],
+          selectedTourIndex: -1,
+          currentStopIndex: null,
+          userLocation: null,
+          lastRoute: null,
+        };
+
+        let map = null;
+        let directionsService = null;
+        let directionsRenderer = null;
+        let userMarker = null;
+        let stopMarkers = [];
+
+        function postToDraftbit(event) {
+          if (!event || typeof event !== "object") return;
+          const payload = JSON.stringify(event);
+          if (
+            window.ReactNativeWebView &&
+            typeof window.ReactNativeWebView.postMessage === "function"
+          ) {
+            window.ReactNativeWebView.postMessage(payload);
+          } else {
+            console.info("Draftbit event", event);
+          }
+        }
+
+        function toNumber(value) {
+          const num = Number(value);
+          return Number.isFinite(num) ? num : null;
+        }
+
+        function normalizeStop(rawStop, index) {
+          if (!rawStop) return null;
+          const latValue =
+            rawStop.lat !== undefined && rawStop.lat !== null
+              ? rawStop.lat
+              : rawStop.latitude;
+          const lngValue =
+            rawStop.lng !== undefined && rawStop.lng !== null
+              ? rawStop.lng
+              : rawStop.longitude;
+          const lat = toNumber(latValue);
+          const lng = toNumber(lngValue);
+          if (lat === null || lng === null) return null;
+          return {
+            id: rawStop.id || `stop-${index + 1}`,
+            name: rawStop.name || `Stop ${index + 1}`,
+            address: rawStop.address || "",
+            description: rawStop.description || rawStop.notes || "",
+            position: { lat, lng },
+          };
+        }
+
+        function normalizeTours(rawTours) {
+          if (!Array.isArray(rawTours)) return [];
+          return rawTours
+            .map((tour, tourIndex) => {
+              const rawStops = tour && Array.isArray(tour.stops) ? tour.stops : [];
+              const stops = rawStops
+                .map((stop, stopIndex) => normalizeStop(stop, stopIndex))
+                .filter(Boolean);
+              if (!stops.length) {
+                return null;
+              }
+              return {
+                id: tour && tour.id ? tour.id : `tour-${tourIndex + 1}`,
+                name: tour && tour.name ? tour.name : `Tour ${tourIndex + 1}`,
+                description:
+                  tour && tour.description ? tour.description : "",
+                stops,
+              };
+            })
+            .filter(Boolean);
+        }
+
+        function getSelectedTour() {
+          if (state.selectedTourIndex < 0) return null;
+          return state.tours[state.selectedTourIndex] || null;
+        }
+
+        function formatStopDetails(stop) {
+          if (!stop) return "";
+          const details = [stop.address, stop.description].filter(Boolean);
+          return details.join("\n");
+        }
+
+        function populateTourSelector() {
+          const { tourSelect, tourSelectRow } = elements;
+          tourSelect.innerHTML = "";
+          state.tours.forEach((tour, index) => {
+            const option = document.createElement("option");
+            option.value = String(index);
+            option.textContent = tour.name;
+            tourSelect.appendChild(option);
+          });
+          if (state.selectedTourIndex >= 0) {
+            tourSelect.value = String(state.selectedTourIndex);
+          }
+          tourSelect.disabled = state.tours.length <= 1;
+          tourSelectRow.style.display = state.tours.length > 1 ? "block" : "none";
+        }
+
+        function resetMetrics() {
+          elements.distance.textContent = "—";
+          elements.duration.textContent = "—";
+          state.lastRoute = null;
+        }
+
+        function clearDirections() {
+          if (
+            directionsRenderer &&
+            typeof directionsRenderer.setDirections === "function"
+          ) {
+            directionsRenderer.setDirections(null);
+          } else if (
+            directionsRenderer &&
+            typeof directionsRenderer.set === "function"
+          ) {
+            directionsRenderer.set("directions", null);
+          }
+        }
+
+        function updatePanel() {
+          const tour = getSelectedTour();
+          if (!tour) {
+            elements.tourName.textContent = "Waiting for tours…";
+            elements.stopName.textContent = "—";
+            elements.stopNotes.textContent = "";
+            elements.stopNotes.style.display = "none";
+            resetMetrics();
+            elements.status.textContent = "Load tours from Draftbit or provide a toursUrl.";
+            elements.startButton.disabled = true;
+            elements.nextButton.disabled = true;
+            elements.nextButton.textContent = "Next stop";
+            elements.startButton.textContent = "Start tour";
+            return;
+          }
+
+          const stopCount = tour.stops.length;
+          elements.tourName.textContent = tour.name;
+          elements.startButton.disabled = stopCount === 0;
+
+          if (state.currentStopIndex === null) {
+            const firstStop = tour.stops[0];
+            if (firstStop) {
+              elements.stopName.textContent = `Next: ${firstStop.name}`;
+              const details = formatStopDetails(firstStop);
+              elements.stopNotes.textContent = details;
+              elements.stopNotes.style.display = details ? "block" : "none";
+            } else {
+              elements.stopName.textContent = "—";
+              elements.stopNotes.textContent = "";
+              elements.stopNotes.style.display = "none";
+            }
+            resetMetrics();
+            elements.status.textContent = state.userLocation
+              ? "Press start to begin navigation."
+              : "Waiting for location from Draftbit…";
+            elements.startButton.textContent = "Start tour";
+            elements.nextButton.disabled = true;
+            elements.nextButton.textContent = "Next stop";
+          } else {
+            const stop = tour.stops[state.currentStopIndex];
+            if (stop) {
+              elements.stopName.textContent = `Stop ${state.currentStopIndex + 1} of ${stopCount}: ${stop.name}`;
+              const details = formatStopDetails(stop);
+              elements.stopNotes.textContent = details;
+              elements.stopNotes.style.display = details ? "block" : "none";
+            } else {
+              elements.stopName.textContent = "—";
+              elements.stopNotes.textContent = "";
+              elements.stopNotes.style.display = "none";
+            }
+            elements.startButton.textContent = "Restart tour";
+            elements.nextButton.disabled = false;
+            const isFinal = state.currentStopIndex >= stopCount - 1;
+            elements.nextButton.textContent = isFinal ? "Finish tour" : "Next stop";
+            elements.status.textContent = isFinal
+              ? "Final stop."
+              : `Heading to stop ${state.currentStopIndex + 1} of ${stopCount}.`;
+          }
+        }
+
+        function clearStopMarkers() {
+          stopMarkers.forEach((marker) => {
+            if (marker && typeof marker.setMap === "function") {
+              marker.setMap(null);
+            }
+          });
+          stopMarkers = [];
+        }
+
+        function updateMarkerHighlight() {
+          stopMarkers.forEach((marker, index) => {
+            const icon =
+              state.currentStopIndex !== null && index === state.currentStopIndex
+                ? "https://maps.gstatic.com/mapfiles/ms2/micons/green-dot.png"
+                : "https://maps.gstatic.com/mapfiles/ms2/micons/red-dot.png";
+            if (marker && typeof marker.setIcon === "function") {
+              marker.setIcon(icon);
+            }
+          });
+        }
+
+        function renderStopMarkers() {
+          if (!map || !window.google || !google.maps) return;
+          clearStopMarkers();
+          const tour = getSelectedTour();
+          if (!tour) return;
+
+          const bounds = new google.maps.LatLngBounds();
+          tour.stops.forEach((stop, index) => {
+            const marker = new google.maps.Marker({
+              map,
+              position: stop.position,
+              title: `Stop ${index + 1}: ${stop.name}`,
+              icon: "https://maps.gstatic.com/mapfiles/ms2/micons/red-dot.png",
             });
+            stopMarkers.push(marker);
+            bounds.extend(stop.position);
+          });
+
+          if (!bounds.isEmpty()) {
+            map.fitBounds(bounds);
+          }
+          updateMarkerHighlight();
+        }
+
+        function selectTourByIndex(index, options = {}) {
+          if (!state.tours.length) {
+            state.selectedTourIndex = -1;
+            state.currentStopIndex = null;
+            updatePanel();
+            return false;
+          }
+          const idx = typeof index === "number" ? index : parseInt(index, 10);
+          if (!Number.isInteger(idx) || idx < 0 || idx >= state.tours.length) {
+            return false;
+          }
 
-            // Initialize directions service and renderer
-            directionsService = new google.maps.DirectionsService();
-            directionsRenderer = new google.maps.DirectionsRenderer({
-                draggable: false,
-                suppressMarkers: false,
+          state.selectedTourIndex = idx;
+          state.currentStopIndex = null;
+          resetMetrics();
+          if (elements.tourSelect.value !== String(idx)) {
+            elements.tourSelect.value = String(idx);
+          }
+          renderStopMarkers();
+          updatePanel();
+
+          if (options.announce !== false) {
+            const tour = getSelectedTour();
+            postToDraftbit({
+              type: "tourSelected",
+              tourId: tour ? tour.id : null,
+              stopCount: tour && tour.stops ? tour.stops.length : 0,
             });
-            directionsRenderer.setMap(map);
-
-            // Add start marker (green)
-            new google.maps.Marker({
-                position: startPoint,
-                map: map,
-                title: "Start: E 12th St",
-                icon: {
-                    url: "http://maps.google.com/mapfiles/ms/icons/green-dot.png"
-                }
+          }
+          return true;
+        }
+
+        function selectTourById(tourId, options = {}) {
+          if (!tourId) return false;
+          const index = state.tours.findIndex((tour) => tour.id === tourId);
+          if (index === -1) return false;
+          return selectTourByIndex(index, options);
+        }
+
+        function loadTours(rawTours, source = "direct") {
+          const tours = normalizeTours(rawTours);
+          if (!tours.length) {
+            console.warn("No valid tours in data source", rawTours);
+            postToDraftbit({
+              type: "toursLoadError",
+              source,
+              message: "No valid tours",
             });
+            if (!state.tours.length) {
+              updatePanel();
+            }
+            return false;
+          }
 
-            // Add end marker (red)
-            new google.maps.Marker({
-                position: endPoint,
-                map: map,
-                title: "End: S Santa Fe Ave",
-                icon: {
-                    url: "http://maps.google.com/mapfiles/ms/icons/red-dot.png"
-                }
+          const previousTour = getSelectedTour();
+          const previouslySelectedId = previousTour ? previousTour.id : null;
+          state.tours = tours;
+          state.selectedTourIndex = -1;
+          state.currentStopIndex = null;
+          populateTourSelector();
+
+          const nextIndex = previouslySelectedId
+            ? tours.findIndex((tour) => tour.id === previouslySelectedId)
+            : 0;
+          selectTourByIndex(nextIndex >= 0 ? nextIndex : 0, { announce: false });
+          updatePanel();
+
+          postToDraftbit({ type: "toursLoaded", count: tours.length, source });
+          const activeTour = getSelectedTour();
+          postToDraftbit({
+            type: "tourSelected",
+            tourId: activeTour ? activeTour.id : null,
+            stopCount:
+              activeTour && activeTour.stops ? activeTour.stops.length : 0,
+          });
+          return true;
+        }
+
+        async function loadToursFromUrl(url) {
+          if (!url) throw new Error("Missing tours URL");
+          try {
+            const response = await fetch(url);
+            if (!response.ok) {
+              throw new Error(`HTTP ${response.status}`);
+            }
+            const data = await response.json();
+            const success = loadTours(data, "remote");
+            if (!success) {
+              throw new Error("No tours found in response");
+            }
+            return true;
+          } catch (error) {
+            console.error("Failed to load tours", error);
+            postToDraftbit({
+              type: "toursLoadError",
+              source: "remote",
+              message: error.message,
+              url,
             });
+            throw error;
+          }
+        }
+
+        function startTour() {
+          const tour = getSelectedTour();
+          if (!tour) return;
+          state.currentStopIndex = 0;
+          resetMetrics();
+          updatePanel();
+          updateMarkerHighlight();
+          showRouteToCurrentStop();
+          postToDraftbit({ type: "tourStarted", tourId: tour.id });
+        }
+
+        function advanceStop() {
+          const tour = getSelectedTour();
+          if (!tour || state.currentStopIndex === null) return;
 
-            // Check URL for location from Draftbit
-            checkURLForLocation();
+          if (state.currentStopIndex >= tour.stops.length - 1) {
+            state.currentStopIndex = null;
+            resetMetrics();
+            updatePanel();
+            updateMarkerHighlight();
+            clearDirections();
+            postToDraftbit({ type: "tourCompleted", tourId: tour.id });
+            return;
+          }
 
-            // Automatically show route
-            showRoute();
+          state.currentStopIndex += 1;
+          resetMetrics();
+          updatePanel();
+          updateMarkerHighlight();
+          showRouteToCurrentStop();
 
-            console.log('Map initialization complete');
+          const stop = tour.stops[state.currentStopIndex];
+          postToDraftbit({
+            type: "advanceStop",
+            tourId: tour.id,
+            stopIndex: state.currentStopIndex,
+            stopId: stop ? stop.id : null,
+          });
         }
 
-        function checkURLForLocation() {
-            const params = new URLSearchParams(window.location.search);
-            const lat = params.get('lat');
-            const lng = params.get('lng');
-            
-            if (lat && lng) {
-                console.log('Location received from Draftbit:', lat, lng);
-                showUserLocation(parseFloat(lat), parseFloat(lng));
+        function setUserLocation(lat, lng, options = {}) {
+          const latitude = toNumber(lat);
+          const longitude = toNumber(lng);
+          if (latitude === null || longitude === null) {
+            console.warn("Ignoring invalid location", lat, lng);
+            return false;
+          }
+
+          const broadcast = options.broadcast !== false;
+          const updateRoute = options.updateRoute !== false;
+
+          state.userLocation = { lat: latitude, lng: longitude };
+          if (state.currentStopIndex === null) {
+            elements.status.textContent = `Current location: ${latitude.toFixed(5)}, ${longitude.toFixed(5)}`;
+          }
+
+          if (map && window.google && window.google.maps) {
+            if (!userMarker) {
+              userMarker = new google.maps.Marker({
+                map,
+                position: state.userLocation,
+                title: "Your location",
+                icon: "https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png",
+              });
+              if (map && typeof map.panTo === "function") {
+                map.panTo(state.userLocation);
+              }
+              if (map && typeof map.getZoom === "function") {
+                const currentZoom = map.getZoom();
+                if (typeof currentZoom === "number" && currentZoom < 15) {
+                  map.setZoom(15);
+                }
+              }
             } else {
-                console.log('No location parameters in URL');
-                document.getElementById('location-status').innerHTML = 
-                    'No location received. Use "Get Location" button in app.';
+              userMarker.setPosition(state.userLocation);
             }
+          }
+
+          if (broadcast) {
+            postToDraftbit({ type: "locationUpdated", lat: latitude, lng: longitude });
+          }
+
+          if (state.currentStopIndex !== null && updateRoute) {
+            showRouteToCurrentStop();
+          }
+
+          return true;
         }
 
-        function showUserLocation(lat, lng) {
-            console.log('Showing user location:', lat, lng);
-            
-            // Remove previous user marker
-            if (userMarker) {
-                userMarker.setMap(null);
-            }
+        function showRouteToCurrentStop() {
+          if (
+            !directionsService ||
+            !directionsRenderer ||
+            !window.google ||
+            !window.google.maps
+          ) {
+            return;
+          }
+          const tour = getSelectedTour();
+          if (!tour || state.currentStopIndex === null) return;
+
+          const stop = tour.stops[state.currentStopIndex];
+          if (!stop) return;
 
-            // Add blue user marker
-            userMarker = new google.maps.Marker({
-                position: { lat: lat, lng: lng },
-                map: map,
-                title: "Your Location",
-                icon: {
-                    url: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png"
+          const origin = state.userLocation
+            ? state.userLocation
+            : state.currentStopIndex > 0
+            ? tour.stops[state.currentStopIndex - 1].position
+            : null;
+
+          if (!origin) {
+            clearDirections();
+            resetMetrics();
+            elements.status.textContent = "Share your location to begin navigation.";
+            if (map) {
+              if (typeof map.panTo === "function") {
+                map.panTo(stop.position);
+              }
+              if (typeof map.getZoom === "function") {
+                const zoom = map.getZoom();
+                if (typeof zoom === "number" && zoom < 15) {
+                  map.setZoom(15);
                 }
-            });
+              }
+            }
+            return;
+          }
+
+          elements.status.textContent = `Routing to ${stop.name}…`;
+
+          const request = {
+            origin,
+            destination: stop.position,
+            travelMode:
+              (google.maps.TravelMode && google.maps.TravelMode.DRIVING) ||
+              "DRIVING",
+            provideRouteAlternatives: false,
+          };
 
-            // Update status
-            document.getElementById('location-status').innerHTML = 
-                `✓ Your location: ${lat.toFixed(4)}, ${lng.toFixed(4)}`;
+          if (google.maps.UnitSystem && google.maps.UnitSystem.IMPERIAL) {
+            request.unitSystem = google.maps.UnitSystem.IMPERIAL;
+          }
+
+          directionsService.route(request, (result, status) => {
+            if (
+              status === "OK" &&
+              result &&
+              Array.isArray(result.routes) &&
+              result.routes.length
+            ) {
+              directionsRenderer.setDirections(result);
+              const firstRoute = result.routes[0];
+              const leg =
+                firstRoute && Array.isArray(firstRoute.legs)
+                  ? firstRoute.legs[0]
+                  : null;
+              const distanceText = leg && leg.distance ? leg.distance.text : null;
+              const durationText = leg && leg.duration ? leg.duration.text : null;
+              const distanceValue =
+                leg &&
+                leg.distance &&
+                typeof leg.distance.value === "number"
+                  ? leg.distance.value
+                  : null;
+              const durationValue =
+                leg &&
+                leg.duration &&
+                typeof leg.duration.value === "number"
+                  ? leg.duration.value
+                  : null;
+              elements.distance.textContent = distanceText || "—";
+              elements.duration.textContent = durationText || "—";
+              state.lastRoute = {
+                origin,
+                destination: stop.position,
+                distanceMeters: distanceValue,
+                durationSeconds: durationValue,
+              };
+              elements.status.textContent = `Navigating to ${stop.name}`;
+              postToDraftbit({
+                type: "routeUpdated",
+                tourId: tour.id,
+                stopId: stop.id,
+                distanceText: distanceText,
+                durationText: durationText,
+              });
+            } else {
+              console.warn("Directions request failed", status, result);
+              clearDirections();
+              resetMetrics();
+              elements.status.textContent = "Unable to build directions. Check your connection.";
+              postToDraftbit({ type: "routeError", status, tourId: tour.id, stopId: stop.id });
+            }
+          });
+        }
+
+        function handleBridgeMessage(event) {
+          if (!event || event.data === undefined || event.data === null) return;
+          let payload = event.data;
+          if (typeof payload === "string") {
+            try {
+              payload = JSON.parse(payload);
+            } catch (error) {
+              return;
+            }
+          }
+          if (!payload || typeof payload !== "object") return;
+
+          switch (payload.type) {
+            case "setLocation":
+              setUserLocation(payload.lat, payload.lng, payload.options || {});
+              break;
+            case "setTours":
+              if (loadTours(payload.tours, payload.source || "bridge") && payload.selectedTourId) {
+                selectTourById(payload.selectedTourId);
+              }
+              break;
+            case "selectTour":
+              if (typeof payload.index === "number") {
+                selectTourByIndex(payload.index);
+              } else if (payload.tourId) {
+                selectTourById(payload.tourId);
+              }
+              break;
+            case "startTour":
+              startTour();
+              break;
+            case "nextStop":
+              advanceStop();
+              break;
+            case "loadToursFromUrl":
+              loadToursFromUrl(payload.url).catch(() => {});
+              break;
+            default:
+              console.debug("Unhandled Draftbit bridge message", payload);
+          }
         }
 
-        function showRoute() {
-            console.log('Showing route...');
-            
-            const request = {
-                origin: startPoint,
-                destination: endPoint,
-                travelMode: google.maps.TravelMode.DRIVING,
-                unitSystem: google.maps.UnitSystem.IMPERIAL,
+        function attachEventListeners() {
+          elements.startButton.addEventListener("click", startTour);
+          elements.nextButton.addEventListener("click", advanceStop);
+          elements.tourSelect.addEventListener("change", (event) => {
+            selectTourByIndex(event.target.value);
+          });
+
+          window.addEventListener("message", handleBridgeMessage);
+          document.addEventListener("message", handleBridgeMessage);
+        }
+
+        function readInitialParams() {
+          const params = new URLSearchParams(window.location.search);
+          const toursUrl = params.get("toursUrl") || params.get("toursurl");
+          const tourId = params.get("tourId") || params.get("tourid");
+          const latParam = params.get("lat");
+          const lngParam = params.get("lng");
+
+          if (latParam && lngParam) {
+            setUserLocation(latParam, lngParam, { broadcast: false });
+          }
+
+          if (toursUrl) {
+            loadToursFromUrl(toursUrl).catch(() => {});
+          }
+
+          if (tourId) {
+            let attempts = 0;
+            const trySelect = () => {
+              if (selectTourById(tourId)) {
+                return;
+              }
+              if (attempts < 20) {
+                attempts += 1;
+                window.setTimeout(trySelect, 200);
+              } else {
+                console.warn(`Tour ${tourId} not found`);
+              }
             };
+            trySelect();
+          }
+        }
 
-            directionsService.route(request, function(result, status) {
-                if (status === "OK") {
-                    console.log('Route loaded successfully');
-                    directionsRenderer.setDirections(result);
-                    
-                    // Update distance and duration
-                    const route = result.routes[0];
-                    const leg = route.legs[0];
-                    
-                    document.getElementById('distance').innerHTML = leg.distance.text;
-                    document.getElementById('duration').innerHTML = leg.duration.text;
-                } else {
-                    console.error('Route error:', status);
-                    document.getElementById('distance').innerHTML = 'Route error';
-                    document.getElementById('duration').innerHTML = 'Route error';
-                }
+        function initMap() {
+          if (!window.google || !window.google.maps) {
+            console.error("Google Maps SDK not available");
+            return;
+          }
+
+          const selectedTour = getSelectedTour();
+          let initialCenter = null;
+          if (selectedTour && Array.isArray(selectedTour.stops) && selectedTour.stops.length) {
+            const firstStop = selectedTour.stops[0];
+            if (firstStop && firstStop.position) {
+              initialCenter = firstStop.position;
+            }
+          }
+          if (!initialCenter) {
+            initialCenter = {
+              lat: 34.052235,
+              lng: -118.243683,
+            };
+          }
+
+          map = new google.maps.Map(document.getElementById("map"), {
+            center: initialCenter,
+            zoom: 14,
+            mapTypeControl: false,
+            fullscreenControl: false,
+            streetViewControl: true,
+          });
+
+          directionsService = new google.maps.DirectionsService();
+          directionsRenderer = new google.maps.DirectionsRenderer({
+            suppressMarkers: true,
+            preserveViewport: true,
+            polylineOptions: {
+              strokeColor: "#2563eb",
+              strokeWeight: 6,
+              strokeOpacity: 0.85,
+            },
+          });
+          directionsRenderer.setMap(map);
+
+          renderStopMarkers();
+          updateMarkerHighlight();
+          updatePanel();
+
+          if (state.userLocation) {
+            setUserLocation(state.userLocation.lat, state.userLocation.lng, {
+              broadcast: false,
+              updateRoute: false,
             });
+            if (state.currentStopIndex !== null) {
+              showRouteToCurrentStop();
+            }
+          }
+
+          postToDraftbit({ type: "mapReady" });
         }
+
+        attachEventListeners();
+        updatePanel();
+        loadTours(fallbackTours, "fallback");
+        readInitialParams();
+
+        window.initMap = initMap;
+        window.setUserLocation = setUserLocation;
+        window.loadTours = loadTours;
+        window.loadToursFromUrl = (url) => loadToursFromUrl(url).catch(() => {});
+        window.selectTourById = selectTourById;
+        window.selectTourByIndex = selectTourByIndex;
+        window.startTour = startTour;
+        window.nextStop = advanceStop;
+
+        window.DraftbitRouteTracker = Object.freeze({
+          setUserLocation,
+          loadTours,
+          loadToursFromUrl: (url) => loadToursFromUrl(url).catch(() => {}),
+          selectTourById,
+          selectTourByIndex,
+          startTour,
+          nextStop: advanceStop,
+          getState: () => ({
+            tours: state.tours,
+            selectedTourIndex: state.selectedTourIndex,
+            currentStopIndex: state.currentStopIndex,
+            userLocation: state.userLocation,
+            lastRoute: state.lastRoute,
+          }),
+        });
+      })();
     </script>
-<script>
-  document.addEventListener('message', (event) => {
-    const { lat, lng } = JSON.parse(event.data);
-    updateDot(lat, lng); // your function that moves the marker
-  });
-</script>
-<div id="map"> … </div>
-<div id="dot"> … </div>
-<script>
-  function updateDot(lat, lng) {
-    // move dot based on lat/lng (your existing logic)
-  }
-
-  document.addEventListener('message', event => {
-    try {
-      const { lat, lng } = JSON.parse(event.data);
-      updateDot(lat, lng);
-    } catch (e) {
-      console.log('Bad message', e);
-    }
-  });
-</script>
-<script>
-  // This lets Draftbit call directly into your map code
-  window.setUserLocation = function(lat, lng) {
-    if (!isNaN(lat) && !isNaN(lng)) {
-      showUserLocation(Number(lat), Number(lng));
-    }
-  };
-</script>
-
-    <!-- Load Google Maps API -->
-    <script async defer
-        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDDdD8BAz34j_0zv-G3qJKTP5sKQn7PQ1w&callback=initMap">
-    </script>
-</body>
+    <script
+      async
+      defer
+      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAMewbFKmFfOAcrOquHVC146fKzNiDfdYs&callback=initMap"
+    ></script>
+  </body>
 </html>
 
EOF
)
