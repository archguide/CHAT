<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LA Maps with Navigation</title>
    <style>
        body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
        #map { height: 100vh; width: 100%; }
        #controls {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            max-width: 320px;
        }
        #navigation-panel {
            position: absolute;
            bottom: 20px;
            left: 10px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            display: none;
        }
        #current-instruction {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #1976d2;
        }
        #distance-time {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }
        #next-instruction {
            font-size: 12px;
            color: #888;
            padding: 8px;
            background: #f5f5f5;
            border-radius: 6px;
        }
        button {
            background: #4285f4;
            color: white;
            border: none;
            padding: 12px 15px;
            border-radius: 6px;
            cursor: pointer;
            margin: 4px 0;
            width: 100%;
            font-size: 14px;
        }
        button:hover { background: #3367d6; }
        button:disabled { 
            background: #ccc; 
            cursor: not-allowed; 
        }
        .nav-button {
            background: #34a853;
            font-size: 16px;
            padding: 12px;
        }
        .nav-button:hover { background: #2d8f43; }
        .test-button {
            background: #9C27B0;
        }
        .test-button:hover { background: #7B1FA2; }
        .force-button {
            background: #FF5722;
            font-weight: bold;
        }
        .force-button:hover { background: #E64A19; }
        .stop-button {
            background: #ea4335;
        }
        .stop-button:hover { background: #d33b2c; }
        #status {
            margin-top: 10px;
            font-size: 12px;
            color: #666;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        #destination-info {
            margin-top: 10px;
            font-size: 12px;
            color: #666;
            padding: 8px;
            background: #e8f5e8;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div id="controls">
        <button onclick="routeToNextStop()">üìç Show Route to Next Stop</button>
        <button onclick="startInAppNavigation()" class="nav-button" id="nav-button" disabled>üß≠ Start Navigation</button>
        <button onclick="testNavigation()" class="test-button">üîç Test Navigation</button>
        <button onclick="forceCreateRoute()" class="force-button">üö® Force Create Test Route</button>
        <button onclick="goToNextStop()">‚è≠Ô∏è Next Destination</button>
        <div id="status">Loading map...</div>
        <div id="destination-info"></div>
    </div>

    <div id="navigation-panel">
        <div id="current-instruction">Turn left onto Main Street</div>
        <div id="distance-time">
            <span id="step-distance">0.3 mi</span> ‚Ä¢ 
            <span id="total-remaining">5 min remaining</span>
        </div>
        <div id="next-instruction">Then: Continue straight for 2.1 miles</div>
        <button onclick="stopNavigation()" class="stop-button">Stop Navigation</button>
    </div>

    <div id="map"></div>

    <script>
        let map;
        let directionsService;
        let directionsRenderer;
        let userLocation = null;
        let currentStopIndex = 0;
        let isNavigating = false;
        let currentRoute = null;
        let currentStepIndex = 0;
        let watchPositionId = null;
        let userMarker = null;
        
        // Define your stops here - Los Angeles landmarks
        const stops = [
            { name: "Hollywood Sign", lat: 34.1341, lng: -118.3215 },
            { name: "Santa Monica Pier", lat: 34.0092, lng: -118.4987 },
            { name: "Griffith Observatory", lat: 34.1184, lng: -118.3004 },
            { name: "Venice Beach", lat: 34.0195, lng: -118.4912 },
            { name: "Downtown LA", lat: 34.0522, lng: -118.2437 }
        ];

        function initMap() {
            // Get location from URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const lat = parseFloat(urlParams.get('lat'));
            const lng = parseFloat(urlParams.get('lng'));
            
            // Default center (Los Angeles)
            let mapCenter = { lat: 34.0522, lng: -118.2437 };
            
            // Check if valid coordinates provided in URL
            if (!isNaN(lat) && !isNaN(lng)) {
                userLocation = { lat: lat, lng: lng };
                mapCenter = userLocation;
                updateStatus(`‚úÖ Location loaded: ${lat.toFixed(4)}, ${lng.toFixed(4)}`);
            } else {
                updateStatus("‚ö†Ô∏è No location in URL. Add ?lat=34.0522&lng=-118.2437");
            }

            // Initialize map
            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 13,
                center: mapCenter,
                mapTypeControl: false,
                streetViewControl: false,
                fullscreenControl: false
            });

            // Initialize directions service and renderer
            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer({
                draggable: false,
                panel: null
            });
            directionsRenderer.setMap(map);

            // Add user location marker if provided
            if (userLocation) {
                updateUserMarker();
            }

            // Add markers for all stops
            stops.forEach((stop, index) => {
                new google.maps.Marker({
                    position: { lat: stop.lat, lng: stop.lng },
                    map: map,
                    title: stop.name,
                    label: (index + 1).toString(),
                    icon: {
                        url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                            <svg width="30" height="40" viewBox="0 0 30 40" xmlns="http://www.w3.org/2000/svg">
                                <path d="M15 0C6.7 0 0 6.7 0 15c0 8.3 15 25 15 25s15-16.7 15-25C30 6.7 23.3 0 15 0z" fill="#4285f4"/>
                                <circle cx="15" cy="15" r="8" fill="white"/>
                                <text x="15" y="20" text-anchor="middle" font-family="Arial" font-size="12" fill="#4285f4">${index + 1}</text>
                            </svg>
                        `),
                        scaledSize: new google.maps.Size(30, 40),
                        anchor: new google.maps.Point(15, 40)
                    }
                });
            });

            // Auto-route to first stop if location provided
            if (userLocation) {
                setTimeout(() => routeToNextStop(), 1500);
            }
        }

        function routeToNextStop() {
            console.log("=== routeToNextStop() called ===");
            
            if (!userLocation) {
                updateStatus("‚ùå No location available. Add ?lat=34.0522&lng=-118.2437 to URL");
                console.log("No user location");
                return;
            }
            console.log("User location:", userLocation);

            if (currentStopIndex >= stops.length) {
                updateStatus("üéâ Tour complete! You've visited all stops.");
                document.getElementById('destination-info').innerHTML = '';
                return;
            }

            const nextStop = stops[currentStopIndex];
            console.log("Next stop:", nextStop);
            updateStatus(`üó∫Ô∏è Getting route to: ${nextStop.name} (${currentStopIndex + 1}/${stops.length})`);
            
            // Update destination info
            document.getElementById('destination-info').innerHTML = `
                <strong>Next Stop:</strong> ${nextStop.name}<br>
                <strong>Coordinates:</strong> ${nextStop.lat.toFixed(4)}, ${nextStop.lng.toFixed(4)}
            `;

            const request = {
                origin: userLocation,
                destination: { lat: nextStop.lat, lng: nextStop.lng },
                travelMode: google.maps.TravelMode.DRIVING,
                avoidTolls: false,
                avoidHighways: false
            };
            
            console.log("Making directions request:", request);

            directionsService.route(request, (result, status) => {
                console.log("=== Directions callback ===");
                console.log("Status:", status);
                console.log("Result:", result);
                
                if (status === 'OK') {
                    directionsRenderer.setDirections(result);
                    currentRoute = result;
                    console.log("‚úÖ Route stored successfully:", currentRoute);
                    
                    const route = result.routes[0];
                    const leg = route.legs[0];
                    const steps = leg.steps;
                    console.log("Number of steps:", steps.length);
                    
                    updateStatus(`‚úÖ Route found: ${leg.distance.text}, ${leg.duration.text}`);
                    
                    // Update destination info with route details
                    document.getElementById('destination-info').innerHTML = `
                        <strong>Next Stop:</strong> ${nextStop.name}<br>
                        <strong>Distance:</strong> ${leg.distance.text}<br>
                        <strong>Duration:</strong> ${leg.duration.text}<br>
                        <em>Click "Start Navigation" for turn-by-turn directions</em>
                    `;
                    
                    // Enable navigation button
                    document.getElementById('nav-button').disabled = false;
                    console.log("Navigation button enabled");
                } else {
                    console.error('‚ùå Directions request failed with status:', status);
                    updateStatus(`‚ùå Directions failed: ${status}. Try "Force Create Test Route"`);
                    document.getElementById('nav-button').disabled = true;
                }
            });
        }

        // Force create a test route (bypasses Google API)
        function forceCreateRoute() {
            console.log("=== FORCE CREATE ROUTE ===");
            
            if (!userLocation) {
                updateStatus("‚ùå No user location. Add ?lat=34.0522&lng=-118.2437 to URL");
                return;
            }
            
            const nextStop = stops[currentStopIndex];
            
            // Create a fake route object for testing
            currentRoute = {
                routes: [{
                    legs: [{
                        distance: { text: "5.2 mi", value: 8369 },
                        duration: { text: "12 mins", value: 720 },
                        steps: [
                            {
                                instructions: "Head <b>north</b> on your current street",
                                distance: { text: "0.3 mi", value: 482 },
                                duration: { text: "1 min", value: 60 }
                            },
                            {
                                instructions: "Turn <b>right</b> onto <b>Hollywood Blvd</b>",
                                distance: { text: "2.1 mi", value: 3379 },
                                duration: { text: "5 mins", value: 300 }
                            },
                            {
                                instructions: "Continue <b>straight</b> to reach Hollywood Sign",
                                distance: { text: "2.8 mi", value: 4506 },
                                duration: { text: "6 mins", value: 360 }
                            }
                        ]
                    }]
                }]
            };
            
            console.log("‚úÖ Fake route created:", currentRoute);
            
            // Enable navigation button
            document.getElementById('nav-button').disabled = false;
            
            updateStatus(`‚úÖ Test route created to ${nextStop.name}! Now try "Start Navigation"`);
            
            // Update destination info
            document.getElementById('destination-info').innerHTML = `
                <strong>Next Stop:</strong> ${nextStop.name} (TEST ROUTE)<br>
                <strong>Distance:</strong> 5.2 mi<br>
                <strong>Duration:</strong> 12 mins<br>
                <em>‚ö° This is a test route. Click "Start Navigation"!</em>
            `;
        }

        // Start in-app turn-by-turn navigation
        function startInAppNavigation() {
            console.log("=== START NAVIGATION CALLED ===");
            console.log("currentRoute exists:", !!currentRoute);
            
            if (!currentRoute) {
                updateStatus("‚ùå No route! Click 'Show Route' or 'Force Create Test Route' first");
                return;
            }

            console.log("Starting navigation with route:", currentRoute);
            
            isNavigating = true;
            currentStepIndex = 0;
            
            // Show navigation panel
            document.getElementById('navigation-panel').style.display = 'block';
            document.getElementById('nav-button').textContent = 'üß≠ Navigating...';
            document.getElementById('nav-button').disabled = true;
            
            console.log("Navigation panel should now be visible");
            
            // Show first instruction immediately
            updateNavigationPanel();
            
            updateStatus("üß≠ Navigation started! Follow directions below.");
            
            // Add manual navigation controls (since location tracking often fails in WebView)
            addManualNavigationControls();
        }

        function addManualNavigationControls() {
            // Add next step button for manual progression
            const existingControls = document.getElementById('manual-controls');
            if (existingControls) {
                existingControls.remove();
            }
            
            const manualControls = document.createElement('div');
            manualControls.id = 'manual-controls';
            manualControls.style.textAlign = 'center';
            manualControls.style.marginTop = '10px';
            manualControls.innerHTML = `
                <button onclick="nextNavigationStep()" style="background: #FF9800; width: 140px; padding: 10px; margin: 5px;">
                    ‚úÖ Completed This Step
                </button>
            `;
            document.getElementById('navigation-panel').appendChild(manualControls);
        }

        function nextNavigationStep() {
            if (!isNavigating || !currentRoute) return;
            
            const steps = currentRoute.routes[0].legs[0].steps;
            currentStepIndex++;
            
            if (currentStepIndex >= steps.length) {
                // Navigation complete
                stopNavigation();
                updateStatus("üéâ You have arrived at your destination!");
                return;
            }
            
            updateNavigationPanel();
        }

        function updateNavigationPanel() {
            console.log("Updating navigation panel...");
            
            if (!currentRoute || !isNavigating) {
                console.log("No route or not navigating");
                return;
            }
            
            const steps = currentRoute.routes[0].legs[0].steps;
            const leg = currentRoute.routes[0].legs[0];
            
            console.log(`Current step: ${currentStepIndex + 1}/${steps.length}`);
            
            if (currentStepIndex >= steps.length) {
                document.getElementById('current-instruction').textContent = "üéâ You have arrived!";
                document.getElementById('distance-time').textContent = "Destination reached";
                document.getElementById('next-instruction').textContent = "Great job completing this leg of the tour!";
                return;
            }
            
            const currentStep = steps[currentStepIndex];
            const nextStep = currentStepIndex + 1 < steps.length ? steps[currentStepIndex + 1] : null;
            
            // Current instruction (remove HTML tags)
            const instruction = currentStep.instructions.replace(/<[^>]*>/g, '');
            document.getElementById('current-instruction').textContent = `${currentStepIndex + 1}. ${instruction}`;
            
            // Distance and time for this step
            document.getElementById('step-distance').textContent = currentStep.distance.text;
            
            // Calculate remaining time (all remaining steps)
            let remainingDistance = 0;
            let remainingDuration = 0;
            for (let i = currentStepIndex; i < steps.length; i++) {
                remainingDistance += steps[i].distance.value;
                remainingDuration += steps[i].duration.value;
            }
            
            const remainingTimeMinutes = Math.ceil(remainingDuration / 60);
            document.getElementById('total-remaining').textContent = `${remainingTimeMinutes} min remaining`;
            
            // Next instruction
            if (nextStep) {
                const nextInstruction = nextStep.instructions.replace(/<[^>]*>/g, '');
                document.getElementById('next-instruction').textContent = `Next: ${nextInstruction}`;
            } else {
                document.getElementById('next-instruction').textContent = "Next: You will arrive at your destination";
            }
            
            console.log("Navigation panel updated successfully");
        }

        function stopNavigation() {
            console.log("Stopping navigation...");
            
            isNavigating = false;
            currentStepIndex = 0;
            
            // Hide navigation panel
            document.getElementById('navigation-panel').style.display = 'none';
            document.getElementById('nav-button').textContent = 'üß≠ Start Navigation';
            document.getElementById('nav-button').disabled = false;
            
            // Remove manual controls if they exist
            const manualControls = document.getElementById('manual-controls');
            if (manualControls) {
                manualControls.remove();
            }
            
            updateStatus("üõë Navigation stopped");
        }

        function goToNextStop() {
            // Stop current navigation if active
            if (isNavigating) {
                stopNavigation();
            }
            
            currentStopIndex++;
            if (currentStopIndex >= stops.length) {
                updateStatus("üéâ Tour complete! You've visited all stops.");
                document.getElementById('destination-info').innerHTML = '<strong>üéâ Congratulations! Tour completed!</strong>';
                return;
            }
            routeToNextStop();
        }

        function updateUserMarker() {
            if (userMarker) {
                userMarker.setMap(null);
            }
            
            userMarker = new google.maps.Marker({
                position: userLocation,
                map: map,
                title: "Your Location",
                icon: {
                    url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                        <svg width="20" height="20" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="10" cy="10" r="8" fill="#34A853" stroke="white" stroke-width="2"/>
                            <circle cx="10" cy="10" r="3" fill="white"/>
                        </svg>
                    `),
                    scaledSize: new google.maps.Size(20, 20),
                    anchor: new google.maps.Point(10, 10)
                }
            });
        }

        // Test function to debug navigation issues
        function testNavigation() {
            console.log("=== TEST NAVIGATION DEBUG ===");
            console.log("userLocation:", userLocation);
            console.log("currentRoute:", currentRoute);
            console.log("currentStopIndex:", currentStopIndex);
            console.log("stops.length:", stops.length);
            console.log("isNavigating:", isNavigating);
            
            // Show detailed info
            let debugInfo = `üîç DEBUG INFO:
‚Ä¢ User Location: ${userLocation ? `${userLocation.lat.toFixed(4)}, ${userLocation.lng.toFixed(4)}` : 'NULL'}
‚Ä¢ Current Route: ${currentRoute ? 'EXISTS ‚úÖ' : 'NULL ‚ùå'}
‚Ä¢ Current Stop: ${currentStopIndex + 1}/${stops.length}
‚Ä¢ Navigation Active: ${isNavigating ? 'YES' : 'NO'}`;
            
            if (currentRoute) {
                const steps = currentRoute.routes[0].legs[0].steps;
                debugInfo += `\n‚Ä¢ Route Steps: ${steps.length}`;
                debugInfo += `\n‚Ä¢ First Step: ${steps[0] ? steps[0].instructions.replace(/<[^>]*>/g, '') : 'N/A'}`;
            }
            
            alert(debugInfo);
            
            if (!currentRoute) {
                updateStatus("‚ùå No route found. Try 'Force Create Test Route' button!");
                return;
            }
            
            // Force show navigation panel for testing
            document.getElementById('navigation-panel').style.display = 'block';
            
            // Test updating the panel with first instruction
            if (currentRoute.routes[0].legs[0].steps.length > 0) {
                const firstStep = currentRoute.routes[0].legs[0].steps[0];
                const instruction = firstStep.instructions.replace(/<[^>]*>/g, '');
                
                document.getElementById('current-instruction').textContent = "üß™ TEST: " + instruction;
                document.getElementById('step-distance').textContent = firstStep.distance.text;
                document.getElementById('total-remaining').textContent = "Test mode";
                document.getElementById('next-instruction').textContent = "This is a test of the navigation panel";
                
                updateStatus("‚úÖ Test navigation panel shown successfully!");
            }
        }

        function updateStatus(message) {
            document.getElementById('status').textContent = message;
        }
    </script>

    <!-- Google Maps API with your key -->
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDDdD8BAz34j_0zv-G3qJKTP5sKQn7PQ1w&callback=initMap">
    </script>
</body>
</html>
