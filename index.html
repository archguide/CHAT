<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LA Navigation</title>
    <style>
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        #map { height: 100vh; width: 100%; }
        #controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            backdrop-filter: blur(10px);
        }
        #navigation-panel {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background: linear-gradient(180deg, rgba(255,255,255,0.95) 0%, rgba(255,255,255,0.9) 100%);
            padding: 50px 20px 20px 20px;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            border-bottom-left-radius: 20px;
            border-bottom-right-radius: 20px;
        }
        #current-instruction {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #1976d2;
            line-height: 1.3;
        }
        #distance-time {
            font-size: 16px;
            color: #666;
            margin-bottom: 8px;
            font-weight: 500;
        }
        #next-instruction {
            font-size: 14px;
            color: #888;
            padding: 10px 15px;
            background: rgba(245,245,245,0.8);
            border-radius: 12px;
            border-left: 4px solid #4285f4;
        }
        button {
            background: #007AFF;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            box-shadow: 0 2px 10px rgba(0,122,255,0.3);
        }
        button:hover { 
            background: #0056CC;
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(0,122,255,0.4);
        }
        button:disabled { 
            background: #ccc; 
            cursor: not-allowed; 
            transform: none;
            box-shadow: none;
        }
        .stop-button {
            background: #FF3B30;
            margin-top: 15px;
            width: 100%;
        }
        .stop-button:hover { background: #D70015; }
        #status {
            font-size: 14px;
            color: white;
            text-align: center;
        }
    </style>
</head>
<body>
    <div id="controls">
        <button onclick="forceCreateRoute()" id="nav-button">üß≠ Start Navigation</button>
        <div id="status">Loading...</div>
    </div>

    <div id="map"></div>

    <script>
        let map;
        let directionsService;
        let directionsRenderer;
        let userLocation = null;
        let isNavigating = false;
        let currentRoute = null;
        let currentStepIndex = 0;
        let userMarker = null;
        let destinationMarker = null;
        
        // Simple destination
        const destination = { name: "Hollywood Sign", lat: 34.1341, lng: -118.3215 };

        function initMap() {
            // Get location from URL
            const urlParams = new URLSearchParams(window.location.search);
            const lat = parseFloat(urlParams.get('lat'));
            const lng = parseFloat(urlParams.get('lng'));
            
            // Set user location
            if (!isNaN(lat) && !isNaN(lng)) {
                userLocation = { lat: lat, lng: lng };
            } else {
                userLocation = { lat: 34.0522, lng: -118.2437 }; // Default LA
            }

            // Initialize map
            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 14,
                center: userLocation,
                mapTypeControl: false,
                streetViewControl: false,
                fullscreenControl: false
            });

            // Initialize directions
            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer({
                draggable: false,
                panel: null,
                suppressMarkers: true,
                polylineOptions: {
                    strokeColor: '#007AFF',
                    strokeWeight: 6,
                    strokeOpacity: 0.9
                }
            });
            directionsRenderer.setMap(map);

            // Add markers
            updateUserMarker();
            addDestinationMarker();
            
            // Start location tracking
            startLocationTracking();
            
            updateStatus(`üìç ${userLocation.lat.toFixed(4)}, ${userLocation.lng.toFixed(4)}`);
        }

        function updateUserMarker() {
            if (userMarker) {
                userMarker.setMap(null);
            }
            
            userMarker = new google.maps.Marker({
                position: userLocation,
                map: map,
                title: "Your Location",
                zIndex: 1000,
                icon: {
                    url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                        <svg width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="12" cy="12" r="11" fill="white" stroke="rgba(0,0,0,0.2)" stroke-width="1"/>
                            <circle cx="12" cy="12" r="8" fill="#007AFF"/>
                        </svg>
                    `),
                    scaledSize: new google.maps.Size(24, 24),
                    anchor: new google.maps.Point(12, 12)
                }
            });
        }

        function addDestinationMarker() {
            destinationMarker = new google.maps.Marker({
                position: { lat: destination.lat, lng: destination.lng },
                map: map,
                title: destination.name,
                icon: {
                    url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                        <svg width="32" height="40" viewBox="0 0 32 40" xmlns="http://www.w3.org/2000/svg">
                            <ellipse cx="16" cy="38" rx="8" ry="2" fill="rgba(0,0,0,0.2)"/>
                            <path d="M16 0C7.2 0 0 7.2 0 16c0 8.8 16 24 16 24s16-15.2 16-24C32 7.2 24.8 0 16 0z" fill="#FF3B30"/>
                            <circle cx="16" cy="16" r="10" fill="white"/>
                            <text x="16" y="21" text-anchor="middle" font-family="-apple-system, BlinkMacSystemFont, sans-serif" font-size="12" font-weight="600" fill="#FF3B30">1</text>
                        </svg>
                    `),
                    scaledSize: new google.maps.Size(32, 40),
                    anchor: new google.maps.Point(16, 40)
                }
            });
        }

        function startLocationTracking() {
            if (!navigator.geolocation) return;
            
            const trackLocation = () => {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        userLocation = { 
                            lat: position.coords.latitude, 
                            lng: position.coords.longitude 
                        };
                        updateUserMarker();
                        
                        // During navigation, keep map centered on user
                        if (isNavigating) {
                            map.panTo(userLocation);
                        } else {
                            updateStatus(`üìç ${userLocation.lat.toFixed(6)}, ${userLocation.lng.toFixed(6)}`);
                        }
                    },
                    (error) => console.log("Location error:", error.message),
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 3000 }
                );
            };
            
            trackLocation();
            setInterval(trackLocation, 2000);
        }

        // Simple route creation with polyline
        function forceCreateRoute() {
            updateStatus("Creating route...");
            
            // Try Google Directions first
            const request = {
                origin: userLocation,
                destination: { lat: destination.lat, lng: destination.lng },
                travelMode: google.maps.TravelMode.DRIVING
            };
            
            directionsService.route(request, (result, status) => {
                if (status === 'OK') {
                    currentRoute = result;
                    directionsRenderer.setDirections(result);
                    
                    const leg = result.routes[0].legs[0];
                    updateStatus(`Ready: ${leg.distance.text}, ${leg.duration.text}`);
                    
                    // Change button to start navigation
                    document.getElementById('nav-button').textContent = 'üß≠ Start Navigation';
                    document.getElementById('nav-button').onclick = startNavigation;
                } else {
                    // Fallback to simple polyline
                    createSimpleRoute();
                }
            });
        }

        function createSimpleRoute() {
            // Create manual polyline
            const routePath = [
                userLocation,
                { lat: userLocation.lat + (destination.lat - userLocation.lat) * 0.5, 
                  lng: userLocation.lng + (destination.lng - userLocation.lng) * 0.5 },
                { lat: destination.lat, lng: destination.lng }
            ];

            new google.maps.Polyline({
                path: routePath,
                geodesic: true,
                strokeColor: '#007AFF',
                strokeOpacity: 0.9,
                strokeWeight: 6,
                map: map
            });

            updateStatus("Ready: Test route to Hollywood Sign");
            document.getElementById('nav-button').textContent = 'üß≠ Start Navigation';
            document.getElementById('nav-button').onclick = startNavigation;
        }

        function startNavigation() {
            isNavigating = true;
            currentStepIndex = 0;
            
            // Hide controls and create navigation panel
            document.getElementById('controls').style.display = 'none';
            createNavigationPanel();
            
            if (userLocation) {
                map.setCenter(userLocation);
                map.setZoom(18);
            }
            
            // Start showing turn-by-turn directions if we have a real route
            if (currentRoute && currentRoute.routes[0].legs[0].steps) {
                updateNavigationPanel();
            } else {
                // Simple navigation for manual route
                document.getElementById('current-instruction').textContent = "Follow the blue line to Hollywood Sign";
                document.getElementById('distance-time').textContent = "Navigate using the route shown";
                document.getElementById('next-instruction').textContent = "Stay on the blue path to reach your destination";
            }
            
            // Start checking navigation progress
            startNavigationTracking();
        }

        // Create navigation panel dynamically
        function createNavigationPanel() {
            const navPanel = document.createElement('div');
            navPanel.id = 'navigation-panel';
            navPanel.innerHTML = `
                <div id="current-instruction"></div>
                <div id="distance-time">
                    <span id="step-distance"></span>
                    <span id="total-remaining"></span>
                </div>
                <div id="next-instruction"></div>
                <button onclick="stopNavigation()" class="stop-button">End Navigation</button>
            `;
            document.body.appendChild(navPanel);
        }

        // Update navigation panel with current step
        function updateNavigationPanel() {
            if (!currentRoute || !isNavigating) return;
            
            const steps = currentRoute.routes[0].legs[0].steps;
            
            if (currentStepIndex >= steps.length) {
                document.getElementById('current-instruction').textContent = "üéâ You have arrived!";
                document.getElementById('step-distance').textContent = "";
                document.getElementById('total-remaining').textContent = "Destination reached";
                document.getElementById('next-instruction').textContent = `Welcome to ${destination.name}!`;
                return;
            }
            
            const currentStep = steps[currentStepIndex];
            const nextStep = currentStepIndex + 1 < steps.length ? steps[currentStepIndex + 1] : null;
            
            // Current instruction (remove HTML tags)
            const instruction = currentStep.instructions.replace(/<[^>]*>/g, '');
            document.getElementById('current-instruction').textContent = instruction;
            
            // Distance and time for this step
            document.getElementById('step-distance').textContent = currentStep.distance.text;
            
            // Calculate remaining time
            let remainingDuration = 0;
            for (let i = currentStepIndex; i < steps.length; i++) {
                remainingDuration += steps[i].duration.value;
            }
            
            const remainingTimeMinutes = Math.ceil(remainingDuration / 60);
            document.getElementById('total-remaining').textContent = ` ‚Ä¢ ${remainingTimeMinutes} min remaining`;
            
            // Next instruction
            if (nextStep) {
                const nextInstruction = nextStep.instructions.replace(/<[^>]*>/g, '');
                document.getElementById('next-instruction').textContent = `Then: ${nextInstruction}`;
            } else {
                document.getElementById('next-instruction').textContent = `Then: Arrive at ${destination.name}`;
            }
        }

        // Track navigation progress
        function startNavigationTracking() {
            if (!isNavigating) return;
            
            const checkProgress = () => {
                if (!isNavigating || !currentRoute) return;
                
                const steps = currentRoute.routes[0].legs[0].steps;
                if (currentStepIndex >= steps.length) return;
                
                const currentStep = steps[currentStepIndex];
                const stepEndLocation = currentStep.end_location;
                
                let stepEndLat, stepEndLng;
                if (typeof stepEndLocation.lat === 'function') {
                    stepEndLat = stepEndLocation.lat();
                    stepEndLng = stepEndLocation.lng();
                } else {
                    stepEndLat = stepEndLocation.lat;
                    stepEndLng = stepEndLocation.lng;
                }
                
                const distance = calculateDistance(
                    userLocation.lat, userLocation.lng,
                    stepEndLat, stepEndLng
                );
                
                // If within 30 meters of step end, move to next step
                if (distance < 0.03) {
                    currentStepIndex++;
                    updateNavigationPanel();
                }
            };
            
            // Check progress every 3 seconds
            const progressInterval = setInterval(() => {
                if (!isNavigating) {
                    clearInterval(progressInterval);
                    return;
                }
                checkProgress();
            }, 3000);
        }

        function stopNavigation() {
            isNavigating = false;
            currentStepIndex = 0;
            
            // Remove navigation panel
            const navPanel = document.getElementById('navigation-panel');
            if (navPanel) {
                navPanel.remove();
            }
            
            // Show controls again
            document.getElementById('controls').style.display = 'block';
            
            if (userLocation) {
                map.setZoom(14);
            }
            
            updateStatus("Navigation ended");
            
            // Change button back
            document.getElementById('nav-button').textContent = 'üß≠ Start Navigation';
            document.getElementById('nav-button').onclick = startNavigation;
        }

        function updateStatus(message) {
            document.getElementById('status').textContent = message;
        }

        // Calculate distance between two points in kilometers
        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371; // Earth's radius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
    </script>

    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDDdD8BAz34j_0zv-G3qJKTP5sKQn7PQ1w&callback=initMap">
    </script>
</body>
</html>
