// Fallback test route with realistic LA street names
        function createTestRoute() {
            if (!userLocation) return;
            
            // Create realistic LA directions
            currentRoute = {
                routes: [{
                    legs: [{
                        distance: { text: "8.2 mi", value: 13193 },
                        duration: { text: "18 mins", value: 1080 },
                        steps: [
                            {
                                instructions: "Head <b>north</b> on <b>S Figueroa St</b> toward <b>W 7th St</b>",
                                distance: { text: "0.4 mi", value: 644 },
                                duration: { text: "2 mins", value: 120 },
                                end_location: { 
                                    lat: userLocation.lat + 0.002, 
                                    lng: userLocation.lng 
                                }
                            },
                            {
                                instructions: "Turn <b>right</b> onto <b>US-101 N</b>",
                                distance: { text: "4.8 mi", value: 7724 },
                                duration: { text: "8 mins", value: 480 },
                                end_location: { 
                                    lat: userLocation.lat + 0.01, 
                                    lng: userLocation.lng + 0.005
                                }
                            },
                            {
                                instructions: "Take exit <b>2B</b> for <b>Gower St</b> toward <b>Hollywood</b>",
                                distance: { text: "0.3 mi", value: 483 },
                                duration: { text: "1 min", value: 60 },
                                end_location: { 
                                    lat: userLocation.lat + 0.015, 
                                    lng: userLocation.lng + 0.008
                                }
                            },
                            {
                                instructions: "Turn <b>left</b> onto <b>Franklin Ave</b>",
                                distance: { text: "1.2 mi", value: 1931 },
                                duration: { text: "4 mins", value: 240 },
                                end_location: { 
                                    lat: userLocation.lat + 0.02, 
                                    lng: userLocation.lng + 0.015
                                }
                            },
                            {
                                instructions<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LA Navigation</title>
    <style>
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        #map { height: 100vh; width: 100%; }
        #controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            backdrop-filter: blur(10px);
        }
        #navigation-panel {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background: linear-gradient(180deg, rgba(255,255,255,0.95) 0%, rgba(255,255,255,0.9) 100%);
            padding: 50px 20px 20px 20px;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            display: none !important; /* Force hidden until navigation starts */
            border-bottom-left-radius: 20px;
            border-bottom-right-radius: 20px;
        }
        #current-instruction {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #1976d2;
            line-height: 1.3;
        }
        #distance-time {
            font-size: 16px;
            color: #666;
            margin-bottom: 8px;
            font-weight: 500;
        }
        #next-instruction {
            font-size: 14px;
            color: #888;
            padding: 10px 15px;
            background: rgba(245,245,245,0.8);
            border-radius: 12px;
            border-left: 4px solid #4285f4;
        }
        button {
            background: #007AFF;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            box-shadow: 0 2px 10px rgba(0,122,255,0.3);
        }
        button:hover { 
            background: #0056CC;
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(0,122,255,0.4);
        }
        button:disabled { 
            background: #ccc; 
            cursor: not-allowed; 
            transform: none;
            box-shadow: none;
        }
        .stop-button {
            background: #FF3B30;
            margin-top: 15px;
            width: 100%;
        }
        .stop-button:hover { background: #D70015; }
        #status {
            font-size: 14px;
            color: white;
            text-align: center;
        }
    </style>
</head>
<body>
    <!-- Navigation panel at top -->
    <div id="navigation-panel">
        <div id="current-instruction">Turn left onto Main Street</div>
        <div id="distance-time">
            <span id="step-distance">0.3 mi</span> • 
            <span id="total-remaining">5 min remaining</span>
        </div>
        <div id="next-instruction">Then: Continue straight for 2.1 miles</div>
        <button onclick="stopNavigation()" class="stop-button">End Navigation</button>
    </div>

    <!-- Simple start button -->
    <div id="controls">
        <button onclick="startInAppNavigation()" id="nav-button" disabled>🧭 Start Navigation</button>
        <div id="status">Loading...</div>
    </div>

    <div id="map"></div>

    <script>
        let map;
        let directionsService;
        let directionsRenderer;
        let userLocation = null;
        let isNavigating = false;
        let currentRoute = null;
        let currentStepIndex = 0;
        let userMarker = null;
        let destinationMarker = null;
        
        // Simple destination - Hollywood Sign
        const destination = { name: "Hollywood Sign", lat: 34.1341, lng: -118.3215 };

        function initMap() {
            // Get location from URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const lat = parseFloat(urlParams.get('lat'));
            const lng = parseFloat(urlParams.get('lng'));
            
            // Default center (Los Angeles)
            let mapCenter = { lat: 34.0522, lng: -118.2437 };
            
            // Check if valid coordinates provided in URL
            if (!isNaN(lat) && !isNaN(lng)) {
                userLocation = { lat: lat, lng: lng };
                mapCenter = userLocation;
                updateStatus(`📍 ${lat.toFixed(4)}, ${lng.toFixed(4)}`);
            } else {
                updateStatus("No location provided");
                userLocation = mapCenter; // Use default
            }

            // Initialize map
            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 14,
                center: mapCenter,
                mapTypeControl: false,
                streetViewControl: false,
                fullscreenControl: false
            });

            // Initialize directions service and renderer
            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer({
                draggable: false,
                panel: null,
                suppressMarkers: true,
                preserveViewport: false,
                polylineOptions: {
                    strokeColor: '#007AFF',
                    strokeWeight: 6,
                    strokeOpacity: 0.9
                }
            });
            directionsRenderer.setMap(map);

            // Add user location marker
            updateUserMarker();
            
            // Add destination marker
            addDestinationMarker();

            // Start location tracking
            startLocationTracking();

            // Create route
            createRoute();
        }

        // Simple location tracking
        function startLocationTracking() {
            if (!navigator.geolocation) {
                console.log("Geolocation not available");
                return;
            }
            
            const trackLocation = () => {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const newLat = position.coords.latitude;
                        const newLng = position.coords.longitude;
                        
                        userLocation = { lat: newLat, lng: newLng };
                        updateUserMarker();
                        
                        if (isNavigating) {
                            map.panTo(userLocation);
                            checkNavigationProgress();
                        }
                        
                        if (!isNavigating) {
                            updateStatus(`📍 ${newLat.toFixed(6)}, ${newLng.toFixed(6)}`);
                        }
                    },
                    (error) => {
                        console.log("Location error:", error.message);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 3000
                    }
                );
            };
            
            trackLocation();
            setInterval(trackLocation, 2000);
        }

        // Update user location marker
        function updateUserMarker() {
            if (userMarker) {
                userMarker.setMap(null);
            }
            
            if (!userLocation) return;
            
            userMarker = new google.maps.Marker({
                position: userLocation,
                map: map,
                title: "Your Location",
                zIndex: 1000,
                icon: {
                    url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                        <svg width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="12" cy="12" r="11" fill="white" stroke="rgba(0,0,0,0.2)" stroke-width="1"/>
                            <circle cx="12" cy="12" r="8" fill="#007AFF"/>
                        </svg>
                    `),
                    scaledSize: new google.maps.Size(24, 24),
                    anchor: new google.maps.Point(12, 12)
                }
            });
        }

        // Add destination marker
        function addDestinationMarker() {
            destinationMarker = new google.maps.Marker({
                position: { lat: destination.lat, lng: destination.lng },
                map: map,
                title: destination.name,
                icon: {
                    url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                        <svg width="32" height="40" viewBox="0 0 32 40" xmlns="http://www.w3.org/2000/svg">
                            <ellipse cx="16" cy="38" rx="8" ry="2" fill="rgba(0,0,0,0.2)"/>
                            <path d="M16 0C7.2 0 0 7.2 0 16c0 8.8 16 24 16 24s16-15.2 16-24C32 7.2 24.8 0 16 0z" fill="#FF3B30"/>
                            <circle cx="16" cy="16" r="10" fill="white"/>
                            <text x="16" y="21" text-anchor="middle" font-family="-apple-system, BlinkMacSystemFont, sans-serif" font-size="12" font-weight="600" fill="#FF3B30">1</text>
                        </svg>
                    `),
                    scaledSize: new google.maps.Size(32, 40),
                    anchor: new google.maps.Point(16, 40)
                }
            });
        }

        // Create route with realistic directions
        function createRoute() {
            if (!userLocation) {
                setTimeout(createRoute, 1000);
                return;
            }
            
            updateStatus("Getting directions...");
            
            const request = {
                origin: userLocation,
                destination: { lat: destination.lat, lng: destination.lng },
                travelMode: google.maps.TravelMode.DRIVING,
                avoidTolls: false,
                avoidHighways: false
            };
            
            directionsService.route(request, (result, status) => {
                if (status === 'OK') {
                    console.log("✅ Google Directions API success");
                    currentRoute = result;
                    
                    // Show the route polyline immediately
                    directionsRenderer.setDirections(result);
                    
                    const route = result.routes[0];
                    const leg = route.legs[0];
                    
                    updateStatus(`Ready: ${leg.distance.text}, ${leg.duration.text}`);
                    document.getElementById('nav-button').disabled = false;
                } else {
                    console.log("❌ Google Directions failed:", status);
                    createTestRoute();
                }
            });
        }

        // Fallback test route with manual polyline
        function createTestRoute() {
            if (!userLocation) return;
            
            console.log("🔄 Creating test route with manual polyline");
            
            // Create realistic LA directions
            currentRoute = {
                routes: [{
                    legs: [{
                        distance: { text: "8.2 mi", value: 13193 },
                        duration: { text: "18 mins", value: 1080 },
                        steps: [
                            {
                                instructions: "Head <b>north</b> on <b>S Figueroa St</b> toward <b>W 7th St</b>",
                                distance: { text: "0.4 mi", value: 644 },
                                duration: { text: "2 mins", value: 120 },
                                end_location: { 
                                    lat: userLocation.lat + 0.002, 
                                    lng: userLocation.lng 
                                }
                            },
                            {
                                instructions: "Turn <b>right</b> onto <b>US-101 N</b>",
                                distance: { text: "4.8 mi", value: 7724 },
                                duration: { text: "8 mins", value: 480 },
                                end_location: { 
                                    lat: userLocation.lat + 0.01, 
                                    lng: userLocation.lng + 0.005
                                }
                            },
                            {
                                instructions: "Take exit <b>2B</b> for <b>Gower St</b> toward <b>Hollywood</b>",
                                distance: { text: "0.3 mi", value: 483 },
                                duration: { text: "1 min", value: 60 },
                                end_location: { 
                                    lat: userLocation.lat + 0.015, 
                                    lng: userLocation.lng + 0.008
                                }
                            },
                            {
                                instructions: "Turn <b>left</b> onto <b>Franklin Ave</b>",
                                distance: { text: "1.2 mi", value: 1931 },
                                duration: { text: "4 mins", value: 240 },
                                end_location: { 
                                    lat: userLocation.lat + 0.02, 
                                    lng: userLocation.lng + 0.015
                                }
                            },
                            {
                                instructions: "Turn <b>right</b> onto <b>Beachwood Dr</b>",
                                distance: { text: "0.8 mi", value: 1287 },
                                duration: { text: "2 mins", value: 120 },
                                end_location: { 
                                    lat: userLocation.lat + 0.025, 
                                    lng: userLocation.lng + 0.018
                                }
                            },
                            {
                                instructions: "Continue onto <b>Ledgewood Dr</b>",
                                distance: { text: "0.5 mi", value: 805 },
                                duration: { text: "1 min", value: 60 },
                                end_location: { 
                                    lat: destination.lat, 
                                    lng: destination.lng 
                                }
                            },
                            {
                                instructions: "Arrive at <b>Hollywood Sign</b> on the right",
                                distance: { text: "0.2 mi", value: 322 },
                                duration: { text: "1 min", value: 60 },
                                end_location: { 
                                    lat: destination.lat, 
                                    lng: destination.lng 
                                }
                            }
                        ]
                    }]
                }]
            };
            
            // Create manual polyline since DirectionsRenderer doesn't work with test data
            createManualPolyline();
            
            updateStatus(`Ready: 8.2 mi, 18 mins`);
            document.getElementById('nav-button').disabled = false;
        }

        // Create manual polyline for test route
        function createManualPolyline() {
            // Simple straight line path from user to destination for now
            const routePath = [
                userLocation,
                { lat: userLocation.lat + (destination.lat - userLocation.lat) * 0.3, lng: userLocation.lng + (destination.lng - userLocation.lng) * 0.3 },
                { lat: userLocation.lat + (destination.lat - userLocation.lat) * 0.6, lng: userLocation.lng + (destination.lng - userLocation.lng) * 0.6 },
                { lat: destination.lat, lng: destination.lng }
            ];

            // Remove existing polyline if any
            if (window.routePolyline) {
                window.routePolyline.setMap(null);
            }

            // Create new polyline
            window.routePolyline = new google.maps.Polyline({
                path: routePath,
                geodesic: true,
                strokeColor: '#007AFF',
                strokeOpacity: 0.9,
                strokeWeight: 6
            });

            window.routePolyline.setMap(map);
            console.log("✅ Manual polyline created");
        }

        // Start navigation
        function startInAppNavigation() {
            if (!currentRoute) return;

            isNavigating = true;
            currentStepIndex = 0;
            
            // Hide controls and show navigation panel
            document.getElementById('controls').style.display = 'none';
            const navPanel = document.getElementById('navigation-panel');
            navPanel.style.display = 'block';
            navPanel.style.setProperty('display', 'block', 'important'); // Override the !important in CSS
            
            // Make sure route line is visible during navigation
            if (directionsRenderer && currentRoute.routes) {
                // If we have a Google route, use DirectionsRenderer
                directionsRenderer.setDirections(currentRoute);
            } else if (window.routePolyline) {
                // If we have a manual polyline, make sure it's visible
                window.routePolyline.setMap(map);
            }
            
            if (userLocation) {
                map.setCenter(userLocation);
                map.setZoom(18);
            }
            
            // Now show the first navigation instruction
            updateNavigationPanel();
        }

        // Update navigation panel with current instruction
        function updateNavigationPanel() {
            if (!currentRoute || !isNavigating) return;
            
            const steps = currentRoute.routes[0].legs[0].steps;
            
            if (currentStepIndex >= steps.length) {
                document.getElementById('current-instruction').textContent = "🎉 You have arrived!";
                document.getElementById('distance-time').textContent = "Destination reached";
                document.getElementById('next-instruction').textContent = `Welcome to ${destination.name}!`;
                return;
            }
            
            const currentStep = steps[currentStepIndex];
            const nextStep = currentStepIndex + 1 < steps.length ? steps[currentStepIndex + 1] : null;
            
            // Current instruction (remove HTML tags)
            const instruction = currentStep.instructions.replace(/<[^>]*>/g, '');
            document.getElementById('current-instruction').textContent = instruction;
            
            // Distance and time for this step
            document.getElementById('step-distance').textContent = currentStep.distance.text;
            
            // Calculate remaining time
            let remainingDuration = 0;
            for (let i = currentStepIndex; i < steps.length; i++) {
                remainingDuration += steps[i].duration.value;
            }
            
            const remainingTimeMinutes = Math.ceil(remainingDuration / 60);
            document.getElementById('total-remaining').textContent = `${remainingTimeMinutes} min remaining`;
            
            // Next instruction
            if (nextStep) {
                const nextInstruction = nextStep.instructions.replace(/<[^>]*>/g, '');
                document.getElementById('next-instruction').textContent = `Then: ${nextInstruction}`;
            } else {
                document.getElementById('next-instruction').textContent = `Then: Arrive at ${destination.name}`;
            }
        }

        // Check if user has progressed to next step
        function checkNavigationProgress() {
            if (!currentRoute || !isNavigating || !userLocation) return;
            
            const steps = currentRoute.routes[0].legs[0].steps;
            if (currentStepIndex >= steps.length) return;
            
            const currentStep = steps[currentStepIndex];
            const stepEndLocation = currentStep.end_location;
            
            let stepEndLat, stepEndLng;
            if (typeof stepEndLocation.lat === 'function') {
                stepEndLat = stepEndLocation.lat();
                stepEndLng = stepEndLocation.lng();
            } else {
                stepEndLat = stepEndLocation.lat;
                stepEndLng = stepEndLocation.lng;
            }
            
            const distance = calculateDistance(
                userLocation.lat, userLocation.lng,
                stepEndLat, stepEndLng
            );
            
            // If within 30 meters of step end, move to next step
            if (distance < 0.03) {
                currentStepIndex++;
                updateNavigationPanel();
            }
        }

        // Stop navigation
        function stopNavigation() {
            isNavigating = false;
            currentStepIndex = 0;
            
            // Hide navigation panel and show controls
            const navPanel = document.getElementById('navigation-panel');
            navPanel.style.display = 'none';
            navPanel.style.setProperty('display', 'none', 'important'); // Ensure it's hidden
            
            document.getElementById('controls').style.display = 'block';
            document.getElementById('nav-button').disabled = false;
            
            // Keep route lines visible (don't hide them)
            // User can see the route even when not navigating
            
            if (userLocation) {
                map.setZoom(14);
            }
            
            updateStatus("Navigation ended");
        }

        function updateStatus(message) {
            document.getElementById('status').textContent = message;
        }

        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
    </script>

    <!-- Google Maps API -->
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDDdD8BAz34j_0zv-G3qJKTP5sKQn7PQ1w&callback=initMap">
    </script>
</body>
</html>
