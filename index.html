<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LA Maps with Navigation</title>
    <style>
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        #map { height: 100vh; width: 100%; }
        #controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            backdrop-filter: blur(10px);
        }
        #navigation-panel {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background: linear-gradient(180deg, rgba(255,255,255,0.95) 0%, rgba(255,255,255,0.9) 100%);
            padding: 50px 20px 20px 20px;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            display: none;
            border-bottom-left-radius: 20px;
            border-bottom-right-radius: 20px;
        }
        #current-instruction {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #1976d2;
            line-height: 1.3;
        }
        #distance-time {
            font-size: 16px;
            color: #666;
            margin-bottom: 8px;
            font-weight: 500;
        }
        #next-instruction {
            font-size: 14px;
            color: #888;
            padding: 10px 15px;
            background: rgba(245,245,245,0.8);
            border-radius: 12px;
            border-left: 4px solid #4285f4;
        }
        button {
            background: #007AFF;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            box-shadow: 0 2px 10px rgba(0,122,255,0.3);
        }
        button:hover { 
            background: #0056CC;
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(0,122,255,0.4);
        }
        button:disabled { 
            background: #ccc; 
            cursor: not-allowed; 
            transform: none;
            box-shadow: none;
        }
        .stop-button {
            background: #FF3B30;
            margin-top: 15px;
            width: 100%;
        }
        .stop-button:hover { background: #D70015; }
        #status {
            font-size: 14px;
            color: white;
            text-align: center;
        }
        
        /* Animated location dot */
        .location-dot {
            width: 20px;
            height: 20px;
            background: #007AFF;
            border: 3px solid white;
            border-radius: 50%;
            box-shadow: 0 0 0 3px rgba(0,122,255,0.3);
            animation: pulse 2s infinite;
        }
        
        .location-dot-outer {
            width: 40px;
            height: 40px;
            background: rgba(0,122,255,0.2);
            border-radius: 50%;
            animation: pulse-outer 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        @keyframes pulse-outer {
            0% { transform: scale(1); opacity: 0.7; }
            50% { transform: scale(1.2); opacity: 0.3; }
            100% { transform: scale(1.4); opacity: 0; }
        }
    </style>
</head>
<body>
    <!-- Navigation panel at top (Apple Maps style) -->
    <div id="navigation-panel">
        <div id="current-instruction">Turn left onto Main Street</div>
        <div id="distance-time">
            <span id="step-distance">0.3 mi</span> ‚Ä¢ 
            <span id="total-remaining">5 min remaining</span>
        </div>
        <div id="next-instruction">Then: Continue straight for 2.1 miles</div>
        <button onclick="stopNavigation()" class="stop-button">End Navigation</button>
    </div>

    <!-- Simple start button for testing -->
    <div id="controls">
        <button onclick="startInAppNavigation()" id="nav-button" disabled>üß≠ Start Navigation</button>
        <div id="status">Loading map...</div>
    </div>

    <div id="map"></div>

    <script>
        let map;
        let directionsService;
        let directionsRenderer;
        let userLocation = null;
        let currentStopIndex = 0;
        let isNavigating = false;
        let currentRoute = null;
        let currentStepIndex = 0;
        let watchPositionId = null;
        let userMarker = null;
        
        // Define your stops here - Los Angeles landmarks
        const stops = [
            { name: "Hollywood Sign", lat: 34.1341, lng: -118.3215 },
            { name: "Santa Monica Pier", lat: 34.0092, lng: -118.4987 },
            { name: "Griffith Observatory", lat: 34.1184, lng: -118.3004 },
            { name: "Venice Beach", lat: 34.0195, lng: -118.4912 },
            { name: "Downtown LA", lat: 34.0522, lng: -118.2437 }
        ];

        function initMap() {
            // Get location from URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const lat = parseFloat(urlParams.get('lat'));
            const lng = parseFloat(urlParams.get('lng'));
            
            // Default center (Los Angeles)
            let mapCenter = { lat: 34.0522, lng: -118.2437 };
            
            // Check if valid coordinates provided in URL
            if (!isNaN(lat) && !isNaN(lng)) {
                userLocation = { lat: lat, lng: lng };
                mapCenter = userLocation;
                updateStatus(`‚úÖ Location loaded: ${lat.toFixed(4)}, ${lng.toFixed(4)}`);
            } else {
                updateStatus("‚ö†Ô∏è No location in URL. Add ?lat=34.0522&lng=-118.2437");
            }

            // Initialize map
            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 16, // Closer zoom for navigation
                center: mapCenter,
                mapTypeControl: false,
                streetViewControl: false,
                fullscreenControl: false
            });

            // Initialize directions service and renderer
            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer({
                draggable: false,
                panel: null,
                suppressMarkers: false // Show turn markers
            });
            directionsRenderer.setMap(map);

            // Add user location marker if provided
            if (userLocation) {
                updateUserMarker();
            }

            // Add markers for all stops
            stops.forEach((stop, index) => {
                new google.maps.Marker({
                    position: { lat: stop.lat, lng: stop.lng },
                    map: map,
                    title: stop.name,
                    label: (index + 1).toString(),
                    icon: {
                        url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                            <svg width="30" height="40" viewBox="0 0 30 40" xmlns="http://www.w3.org/2000/svg">
                                <path d="M15 0C6.7 0 0 6.7 0 15c0 8.3 15 25 15 25s15-16.7 15-25C30 6.7 23.3 0 15 0z" fill="#4285f4"/>
                                <circle cx="15" cy="15" r="8" fill="white"/>
                                <text x="15" y="20" text-anchor="middle" font-family="Arial" font-size="12" fill="#4285f4">${index + 1}</text>
                            </svg>
                        `),
                        scaledSize: new google.maps.Size(30, 40),
                        anchor: new google.maps.Point(15, 40)
                    }
                });
            });

            // Listen for location updates from Draftbit
            setupLocationListener();

            // Auto-create route and enable navigation for testing
            if (userLocation) {
                setTimeout(() => {
                    forceCreateRoute(); // Create test route
                }, 1500);
            }
        }

        // Listen for location updates from Draftbit
        function setupLocationListener() {
            window.addEventListener('message', function(event) {
                try {
                    const data = JSON.parse(event.data);
                    
                    if (data.type === 'locationUpdate') {
                        handleLocationUpdate(data.latitude, data.longitude);
                    }
                } catch (e) {
                    // Not a JSON message, ignore
                }
            });
            
            console.log("‚úÖ Location listener setup - ready for Draftbit updates");
            updateStatus("üîÑ Ready to receive location updates from Draftbit");
        }

        // Handle location updates from Draftbit
        function handleLocationUpdate(lat, lng) {
            console.log("üìç Location update received:", lat, lng);
            
            const newLocation = { lat: lat, lng: lng };
            userLocation = newLocation;
            
            // Update user marker position
            updateUserMarker();
            
            // Keep map centered on user (optional - can be toggled)
            if (isNavigating) {
                map.setCenter(userLocation);
            }
            
            // Check navigation progress if we're navigating
            if (isNavigating && currentRoute) {
                checkNavigationProgress();
            }
            
            // Update status with current location
            updateStatus(`üìç Location: ${lat.toFixed(6)}, ${lng.toFixed(6)}`);
        }

        // Check if user has reached the next navigation step
        function checkNavigationProgress() {
            if (!currentRoute || !isNavigating || !userLocation) return;
            
            const steps = currentRoute.routes[0].legs[0].steps;
            if (currentStepIndex >= steps.length) return;
            
            const currentStep = steps[currentStepIndex];
            const stepEndLocation = currentStep.end_location;
            
            // For real Google API results, use lat() and lng() functions
            let stepEndLat, stepEndLng;
            if (typeof stepEndLocation.lat === 'function') {
                stepEndLat = stepEndLocation.lat();
                stepEndLng = stepEndLocation.lng();
            } else {
                // For our test route
                stepEndLat = stepEndLocation.lat;
                stepEndLng = stepEndLocation.lng;
            }
            
            // Calculate distance to end of current step
            const distance = calculateDistance(
                userLocation.lat, userLocation.lng,
                stepEndLat, stepEndLng
            );
            
            console.log(`Distance to next turn: ${(distance * 1000).toFixed(0)}m`);
            
            // If within 30 meters of step end, move to next step
            if (distance < 0.03) { // 30 meters in km
                console.log("üéØ Reached waypoint! Advancing to next step");
                currentStepIndex++;
                updateNavigationPanel();
                
                // Play a notification sound or vibration here if possible
                if (currentStepIndex < steps.length) {
                    updateStatus("‚úÖ Step completed! Next instruction loaded.");
                }
            }
        }

        // Force create a test route (bypasses Google API) - for testing
        function forceCreateRoute() {
            console.log("=== FORCE CREATE ROUTE ===");
            
            if (!userLocation) {
                updateStatus("‚ùå No user location. Add ?lat=34.0522&lng=-118.2437 to URL");
                return;
            }
            
            const nextStop = stops[currentStopIndex];
            
            // Create a fake route object for testing with realistic waypoints
            currentRoute = {
                routes: [{
                    legs: [{
                        distance: { text: "5.2 mi", value: 8369 },
                        duration: { text: "12 mins", value: 720 },
                        steps: [
                            {
                                instructions: "Head <b>north</b> on your current street",
                                distance: { text: "0.3 mi", value: 482 },
                                duration: { text: "1 min", value: 60 },
                                end_location: { 
                                    lat: userLocation.lat + 0.003, 
                                    lng: userLocation.lng 
                                }
                            },
                            {
                                instructions: "Turn <b>right</b> onto <b>Hollywood Blvd</b>",
                                distance: { text: "2.1 mi", value: 3379 },
                                duration: { text: "5 mins", value: 300 },
                                end_location: { 
                                    lat: userLocation.lat + 0.006, 
                                    lng: userLocation.lng + 0.01 
                                }
                            },
                            {
                                instructions: "Continue <b>straight</b> to reach Hollywood Sign",
                                distance: { text: "2.8 mi", value: 4506 },
                                duration: { text: "6 mins", value: 360 },
                                end_location: { 
                                    lat: nextStop.lat, 
                                    lng: nextStop.lng 
                                }
                            }
                        ]
                    }]
                }]
            };
            
            console.log("‚úÖ Test route created:", currentRoute);
            
            // Enable navigation button
            document.getElementById('nav-button').disabled = false;
            
            updateStatus(`‚úÖ Ready to navigate to ${nextStop.name}`);
        }

        // Start in-app turn-by-turn navigation
        function startInAppNavigation() {
            console.log("=== START NAVIGATION CALLED ===");
            console.log("currentRoute exists:", !!currentRoute);
            
            if (!currentRoute) {
                updateStatus("‚ùå No route available");
                return;
            }

            console.log("Starting navigation with route:", currentRoute);
            
            isNavigating = true;
            currentStepIndex = 0;
            
            // Hide controls and show navigation panel
            document.getElementById('controls').style.display = 'none';
            document.getElementById('navigation-panel').style.display = 'block';
            
            // Set closer zoom for navigation
            if (userLocation) {
                map.setCenter(userLocation);
                map.setZoom(18);
            }
            
            console.log("Navigation panel should now be visible");
            
            // Show first instruction immediately
            updateNavigationPanel();
            
            // No manual controls needed for testing - will use real GPS
            console.log("üß≠ LIVE Navigation started - GPS tracking active");
        }

        function updateNavigationPanel() {
            console.log("Updating navigation panel...");
            
            if (!currentRoute || !isNavigating) {
                console.log("No route or not navigating");
                return;
            }
            
            const steps = currentRoute.routes[0].legs[0].steps;
            const leg = currentRoute.routes[0].legs[0];
            
            console.log(`Current step: ${currentStepIndex + 1}/${steps.length}`);
            
            if (currentStepIndex >= steps.length) {
                document.getElementById('current-instruction').textContent = "üéâ You have arrived!";
                document.getElementById('distance-time').textContent = "Destination reached";
                document.getElementById('next-instruction').textContent = "Great job completing this leg of the tour!";
                return;
            }
            
            const currentStep = steps[currentStepIndex];
            const nextStep = currentStepIndex + 1 < steps.length ? steps[currentStepIndex + 1] : null;
            
            // Current instruction (remove HTML tags)
            const instruction = currentStep.instructions.replace(/<[^>]*>/g, '');
            document.getElementById('current-instruction').textContent = instruction;
            
            // Distance and time for this step
            document.getElementById('step-distance').textContent = currentStep.distance.text;
            
            // Calculate remaining time (all remaining steps)
            let remainingDistance = 0;
            let remainingDuration = 0;
            for (let i = currentStepIndex; i < steps.length; i++) {
                remainingDistance += steps[i].distance.value;
                remainingDuration += steps[i].duration.value;
            }
            
            const remainingTimeMinutes = Math.ceil(remainingDuration / 60);
            document.getElementById('total-remaining').textContent = `${remainingTimeMinutes} min remaining`;
            
            // Next instruction
            if (nextStep) {
                const nextInstruction = nextStep.instructions.replace(/<[^>]*>/g, '');
                document.getElementById('next-instruction').textContent = `Then: ${nextInstruction}`;
            } else {
                document.getElementById('next-instruction').textContent = "Then: You will arrive at your destination";
            }
            
            console.log("Navigation panel updated successfully");
        }

        function stopNavigation() {
            console.log("Stopping navigation...");
            
            isNavigating = false;
            currentStepIndex = 0;
            
            // Hide navigation panel and show controls
            document.getElementById('navigation-panel').style.display = 'none';
            document.getElementById('controls').style.display = 'block';
            document.getElementById('nav-button').disabled = false;
            
            // Zoom out to overview
            if (userLocation) {
                map.setZoom(14);
            }
            
            updateStatus("Navigation ended");
        }

        function goToNextStop() {
            // Stop current navigation if active
            if (isNavigating) {
                stopNavigation();
            }
            
            currentStopIndex++;
            if (currentStopIndex >= stops.length) {
                updateStatus("üéâ Tour complete! You've visited all stops.");
                document.getElementById('destination-info').innerHTML = '<strong>üéâ Congratulations! Tour completed!</strong>';
                return;
            }
            routeToNextStop();
        }

        function updateUserMarker() {
            if (userMarker) {
                userMarker.setMap(null);
            }
            
            // Create animated location dot
            userMarker = new google.maps.Marker({
                position: userLocation,
                map: map,
                title: "Your Location",
                icon: {
                    url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                        <svg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
                            <!-- Outer pulsing ring -->
                            <circle cx="20" cy="20" r="18" fill="rgba(0,122,255,0.2)">
                                <animate attributeName="r" values="18;22;18" dur="2s" repeatCount="indefinite"/>
                                <animate attributeName="opacity" values="0.7;0;0.7" dur="2s" repeatCount="indefinite"/>
                            </circle>
                            <!-- Middle ring -->
                            <circle cx="20" cy="20" r="12" fill="rgba(0,122,255,0.3)" stroke="white" stroke-width="2"/>
                            <!-- Inner dot -->
                            <circle cx="20" cy="20" r="6" fill="#007AFF" stroke="white" stroke-width="2">
                                <animate attributeName="r" values="6;7;6" dur="2s" repeatCount="indefinite"/>
                            </circle>
                        </svg>
                    `),
                    scaledSize: new google.maps.Size(40, 40),
                    anchor: new google.maps.Point(20, 20)
                }
            });
        }

        // Test function to debug navigation issues
        function testNavigation() {
            console.log("=== TEST NAVIGATION DEBUG ===");
            console.log("userLocation:", userLocation);
            console.log("currentRoute:", currentRoute);
            console.log("currentStopIndex:", currentStopIndex);
            console.log("stops.length:", stops.length);
            console.log("isNavigating:", isNavigating);
            
            // Show detailed info
            let debugInfo = `üîç DEBUG INFO:
‚Ä¢ User Location: ${userLocation ? `${userLocation.lat.toFixed(4)}, ${userLocation.lng.toFixed(4)}` : 'NULL'}
‚Ä¢ Current Route: ${currentRoute ? 'EXISTS ‚úÖ' : 'NULL ‚ùå'}
‚Ä¢ Current Stop: ${currentStopIndex + 1}/${stops.length}
‚Ä¢ Navigation Active: ${isNavigating ? 'YES' : 'NO'}`;
            
            if (currentRoute) {
                const steps = currentRoute.routes[0].legs[0].steps;
                debugInfo += `\n‚Ä¢ Route Steps: ${steps.length}`;
                debugInfo += `\n‚Ä¢ First Step: ${steps[0] ? steps[0].instructions.replace(/<[^>]*>/g, '') : 'N/A'}`;
            }
            
            alert(debugInfo);
            
            if (!currentRoute) {
                updateStatus("‚ùå No route found. Try 'Force Create Test Route' button!");
                return;
            }
            
            // Force show navigation panel for testing
            document.getElementById('navigation-panel').style.display = 'block';
            
            // Test updating the panel with first instruction
            if (currentRoute.routes[0].legs[0].steps.length > 0) {
                const firstStep = currentRoute.routes[0].legs[0].steps[0];
                const instruction = firstStep.instructions.replace(/<[^>]*>/g, '');
                
                document.getElementById('current-instruction').textContent = "üß™ TEST: " + instruction;
                document.getElementById('step-distance').textContent = firstStep.distance.text;
                document.getElementById('total-remaining').textContent = "Test mode";
                document.getElementById('next-instruction').textContent = "This is a test of the navigation panel";
                
                updateStatus("‚úÖ Test navigation panel shown successfully!");
            }
        }

        function updateStatus(message) {
            document.getElementById('status').textContent = message;
        }

        // Calculate distance between two points in kilometers
        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371; // Earth's radius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
    </script>

    <!-- Google Maps API with your key -->
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDDdD8BAz34j_0zv-G3qJKTP5sKQn7PQ1w&callback=initMap">
    </script>
</body>
</html>
