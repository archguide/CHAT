<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LA Navigation - Tours</title>
    <style>
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        #map { height: 100vh; width: 100%; }
        #controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            backdrop-filter: blur(10px);
        }
        #navigation-panel {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background: linear-gradient(180deg, rgba(255,255,255,0.95) 0%, rgba(255,255,255,0.9) 100%);
            padding: 50px 20px 20px 20px;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            display: none;
            border-bottom-left-radius: 20px;
            border-bottom-right-radius: 20px;
        }
        #current-instruction {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #1976d2;
            line-height: 1.3;
        }
        #distance-time {
            font-size: 16px;
            color: #666;
            margin-bottom: 8px;
            font-weight: 500;
        }
        #next-instruction {
            font-size: 14px;
            color: #888;
            padding: 10px 15px;
            background: rgba(245,245,245,0.8);
            border-radius: 12px;
            border-left: 4px solid #4285f4;
        }
        button {
            background: #007AFF;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            box-shadow: 0 2px 10px rgba(0,122,255,0.3);
        }
        button:hover { 
            background: #0056CC;
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(0,122,255,0.4);
        }
        button:disabled { 
            background: #ccc; 
            cursor: not-allowed; 
            transform: none;
            box-shadow: none;
        }
        .stop-button {
            background: #FF3B30;
            margin-top: 15px;
            width: 100%;
        }
        .stop-button:hover { background: #D70015; }
        #status {
            font-size: 14px;
            color: white;
            text-align: center;
        }
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 20px 30px;
            border-radius: 20px;
            font-size: 16px;
            z-index: 2000;
        }
    </style>
</head>
<body>
    <!-- Loading indicator -->
    <div id="loading">Loading tour data...</div>

    <!-- Navigation panel at top (Apple Maps style) -->
    <div id="navigation-panel">
        <div id="current-instruction">Turn left onto Main Street</div>
        <div id="distance-time">
            <span id="step-distance">0.3 mi</span> â€¢ 
            <span id="total-remaining">5 min remaining</span>
        </div>
        <div id="next-instruction">Then: Continue straight for 2.1 miles</div>
        <button onclick="stopNavigation()" class="stop-button">End Navigation</button>
    </div>

    <!-- Simple start button for testing -->
    <div id="controls">
        <button onclick="startInAppNavigation()" id="nav-button" disabled>ðŸ§­ Start Navigation</button>
        <div id="status">Loading...</div>
    </div>

    <div id="map"></div>

    <script>
        let map;
        let directionsService;
        let directionsRenderer;
        let userLocation = null;
        let currentStopIndex = 0;
        let isNavigating = false;
        let currentRoute = null;
        let currentStepIndex = 0;
        let userMarker = null;
        
        // Tour data loaded from Google Sheets
        let tourStops = [];
        let tourInfo = {};
        
        // Google Sheets configuration
        const GOOGLE_SHEETS_URL = "https://docs.google.com/spreadsheets/d/YOUR_SHEET_ID/pub?output=csv";

        async function initMap() {
            // Get URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const lat = parseFloat(urlParams.get('lat'));
            const lng = parseFloat(urlParams.get('lng'));
            const tourId = urlParams.get('tour') || 'hollywood'; // Default tour
            const stopIndex = parseInt(urlParams.get('stop')) || 0;
            const autoStart = urlParams.get('auto') === 'true'; // Simple auto parameter
            
            // Set current stop index
            currentStopIndex = stopIndex;
            
            // Default center (Los Angeles)
            let mapCenter = { lat: 34.0522, lng: -118.2437 };
            
            // Check if valid coordinates provided in URL
            if (!isNaN(lat) && !isNaN(lng)) {
                userLocation = { lat: lat, lng: lng };
                mapCenter = userLocation;
                updateStatus(`Location: ${lat.toFixed(4)}, ${lng.toFixed(4)}`);
            } else {
                updateStatus("No location in URL - using default");
                userLocation = mapCenter; // Use default location
            }

            // Initialize map
            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 16,
                center: mapCenter,
                mapTypeControl: false,
                streetViewControl: false,
                fullscreenControl: false,
                styles: [
                    {
                        featureType: "poi",
                        elementType: "labels",
                        stylers: [{ visibility: "off" }]
                    }
                ]
            });

            // Initialize directions service and renderer
            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer({
                draggable: false,
                panel: null,
                suppressMarkers: true, // Hide default markers, we'll use custom ones
                polylineOptions: {
                    strokeColor: '#007AFF',
                    strokeWeight: 6,
                    strokeOpacity: 0.8
                }
            });
            directionsRenderer.setMap(map);

            // Load tour data from Google Sheets
            try {
                await loadTourData(tourId);
                
                // Add user location marker
                updateUserMarker();

                // Add markers for tour stops
                addTourMarkers();

                // Start continuous location tracking (WebView handles this)
                startContinuousLocationTracking();

                // Create route to current stop
                if (tourStops.length > 0) {
                    await createRouteToCurrentStop();
                    
                    // Auto-start navigation if requested
                    if (autoStart) {
                        updateStatus("Auto-starting navigation...");
                        setTimeout(() => {
                            startInAppNavigation();
                        }, 2000);
                    } else {
                        // Show start button
                        document.getElementById('nav-button').disabled = false;
                    }
                }
                
                // Hide loading indicator
                document.getElementById('loading').style.display = 'none';
                
            } catch (error) {
                console.error('Error loading tour data:', error);
                updateStatus('Error loading tour data');
                document.getElementById('loading').textContent = 'Error loading tour data. Using test data.';
                
                // Fallback to test data if sheets fail
                createTestTourData(tourId);
                addTourMarkers(); // This will now show only current destination
                await createTestRoute();
                
                if (autoStart) {
                    setTimeout(() => startInAppNavigation(), 2000);
                }
                
                document.getElementById('loading').style.display = 'none';
            }
        }

        // Continuous location tracking (WebView handles this automatically)
        function startContinuousLocationTracking() {
            if (!navigator.geolocation) {
                console.log("Geolocation not available");
                return;
            }
            
            // Update location every 5 seconds
            const trackLocation = () => {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const newLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        
                        // Only update if location changed significantly (>5 meters)
                        if (userLocation) {
                            const distance = calculateDistance(
                                userLocation.lat, userLocation.lng,
                                newLocation.lat, newLocation.lng
                            );
                            
                            if (distance > 0.005) { // 5 meters
                                handleLocationUpdate(newLocation.lat, newLocation.lng);
                            }
                        } else {
                            handleLocationUpdate(newLocation.lat, newLocation.lng);
                        }
                    },
                    (error) => {
                        console.log("Location tracking error:", error.message);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 15000,
                        maximumAge: 10000
                    }
                );
            };
            
            // Initial location
            trackLocation();
            
            // Track every 5 seconds
            setInterval(trackLocation, 5000);
            
            console.log("âœ… Continuous location tracking started");
        }

        // Create test tour data if Google Sheets fails
        function createTestTourData(tourId) {
            console.log("Creating test tour data for:", tourId);
            
            const testTours = {
                hollywood: {
                    name: "Hollywood Tour",
                    stops: [
                        { name: "Hollywood Sign", lat: 34.1341, lng: -118.3215, description: "Iconic landmark" },
                        { name: "Walk of Fame", lat: 34.1016, lng: -118.3416, description: "Celebrity stars" },
                        { name: "TCL Theatre", lat: 34.1022, lng: -118.3406, description: "Movie premieres" }
                    ]
                },
                beaches: {
                    name: "LA Beaches Tour",
                    stops: [
                        { name: "Santa Monica Pier", lat: 34.0092, lng: -118.4987, description: "Amusement pier" },
                        { name: "Venice Beach", lat: 34.0195, lng: -118.4912, description: "Boardwalk" },
                        { name: "Manhattan Beach", lat: 33.8847, lng: -118.4109, description: "Upscale beach" }
                    ]
                },
                downtown: {
                    name: "Downtown LA Tour",
                    stops: [
                        { name: "Disney Concert Hall", lat: 34.0555, lng: -118.2496, description: "Architecture" },
                        { name: "Grand Central Market", lat: 34.0506, lng: -118.2496, description: "Food hall" },
                        { name: "LA City Hall", lat: 34.0522, lng: -118.2437, description: "Government" }
                    ]
                }
            };
            
            const selectedTour = testTours[tourId] || testTours.hollywood;
            
            tourStops = selectedTour.stops;
            tourInfo = {
                id: tourId,
                name: selectedTour.name,
                totalStops: selectedTour.stops.length
            };
            
            console.log("Test tour created:", tourInfo);
            updateStatus(`${tourInfo.name} loaded (test data)`);
        }

        // Create test route (bypass Google Directions API)
        async function createTestRoute() {
            return new Promise((resolve) => {
                console.log("Creating test route...");
                
                if (!userLocation || currentStopIndex >= tourStops.length) {
                    console.log("No user location or invalid stop index");
                    resolve();
                    return;
                }
                
                const currentStop = tourStops[currentStopIndex];
                console.log("Creating route to:", currentStop.name);
                
                // Create fake route with realistic directions
                currentRoute = {
                    routes: [{
                        legs: [{
                            distance: { text: "2.5 mi", value: 4023 },
                            duration: { text: "8 mins", value: 480 },
                            steps: [
                                {
                                    instructions: `Head toward <b>${currentStop.name}</b>`,
                                    distance: { text: "0.5 mi", value: 804 },
                                    duration: { text: "2 min", value: 120 },
                                    end_location: { 
                                        lat: userLocation.lat + (currentStop.lat - userLocation.lat) * 0.3, 
                                        lng: userLocation.lng + (currentStop.lng - userLocation.lng) * 0.3
                                    }
                                },
                                {
                                    instructions: "Continue straight for 1.2 miles",
                                    distance: { text: "1.2 mi", value: 1931 },
                                    duration: { text: "4 min", value: 240 },
                                    end_location: { 
                                        lat: userLocation.lat + (currentStop.lat - userLocation.lat) * 0.7, 
                                        lng: userLocation.lng + (currentStop.lng - userLocation.lng) * 0.7
                                    }
                                },
                                {
                                    instructions: `Arrive at <b>${currentStop.name}</b>`,
                                    distance: { text: "0.8 mi", value: 1288 },
                                    duration: { text: "2 min", value: 120 },
                                    end_location: { 
                                        lat: currentStop.lat, 
                                        lng: currentStop.lng 
                                    }
                                }
                            ]
                        }]
                    }]
                };
                
                console.log("âœ… Test route created successfully");
                updateStatus(`Ready - Route to ${currentStop.name} (2.5 mi, 8 mins)`);
                document.getElementById('nav-button').disabled = false;
                resolve(currentRoute);
            });
        }

        // Load tour data from Google Sheets
        async function loadTourData(tourId) {
            updateStatus('Loading tour data from Google Sheets...');
            
            // Skip Google Sheets for testing - just throw error to use test data
            throw new Error("Using test data for development");
            
            /* Uncomment this section when you have Google Sheets URL set up:
            
            try {
                const response = await fetch(GOOGLE_SHEETS_URL);
                const csvText = await response.text();
                
                // Parse CSV data
                const lines = csvText.split('\n');
                const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                
                const allTours = [];
                for (let i = 1; i < lines.length; i++) {
                    const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
                    if (values.length >= headers.length && values[0]) {
                        const tour = {};
                        headers.forEach((header, index) => {
                            tour[header] = values[index];
                        });
                        allTours.push(tour);
                    }
                }
                
                // Filter stops for current tour
                tourStops = allTours
                    .filter(stop => stop.tour_id === tourId)
                    .sort((a, b) => parseInt(a.stop_number) - parseInt(b.stop_number))
                    .map(stop => ({
                        name: stop.stop_name,
                        lat: parseFloat(stop.latitude),
                        lng: parseFloat(stop.longitude),
                        description: stop.description
                    }));
                
                // Set tour info
                const firstStop = allTours.find(stop => stop.tour_id === tourId);
                if (firstStop) {
                    tourInfo = {
                        id: tourId,
                        name: firstStop.tour_name,
                        totalStops: tourStops.length
                    };
                }
                
                console.log(`Loaded ${tourStops.length} stops for ${tourInfo.name}`);
                updateStatus(`${tourInfo.name} loaded from Google Sheets`);
                
            } catch (error) {
                console.error('Error fetching tour data:', error);
                throw error;
            }
            
            */
        }

        // Add marker for current destination only (Apple Maps style)
        function addTourMarkers() {
            // Clear any existing destination marker
            if (window.destinationMarker) {
                window.destinationMarker.setMap(null);
            }
            
            // Only show marker for current destination
            if (currentStopIndex < tourStops.length) {
                const currentStop = tourStops[currentStopIndex];
                
                window.destinationMarker = new google.maps.Marker({
                    position: { lat: currentStop.lat, lng: currentStop.lng },
                    map: map,
                    title: currentStop.name,
                    icon: {
                        url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                            <svg width="32" height="40" viewBox="0 0 32 40" xmlns="http://www.w3.org/2000/svg">
                                <!-- Pin shadow -->
                                <ellipse cx="16" cy="38" rx="8" ry="2" fill="rgba(0,0,0,0.2)"/>
                                <!-- Pin body -->
                                <path d="M16 0C7.2 0 0 7.2 0 16c0 8.8 16 24 16 24s16-15.2 16-24C32 7.2 24.8 0 16 0z" fill="#FF3B30"/>
                                <!-- White circle for number -->
                                <circle cx="16" cy="16" r="10" fill="white"/>
                                <!-- Number -->
                                <text x="16" y="21" text-anchor="middle" font-family="-apple-system, BlinkMacSystemFont, sans-serif" font-size="12" font-weight="600" fill="#FF3B30">${currentStopIndex + 1}</text>
                            </svg>
                        `),
                        scaledSize: new google.maps.Size(32, 40),
                        anchor: new google.maps.Point(16, 40)
                    }
                });
            }
        }

        // Create route to current stop
        async function createRouteToCurrentStop() {
            if (!userLocation || currentStopIndex >= tourStops.length) {
                return;
            }
            
            const currentStop = tourStops[currentStopIndex];
            updateStatus(`Getting route to ${currentStop.name}...`);
            
            const request = {
                origin: userLocation,
                destination: { lat: currentStop.lat, lng: currentStop.lng },
                travelMode: google.maps.TravelMode.DRIVING,
                avoidTolls: false,
                avoidHighways: false
            };
            
            return new Promise((resolve, reject) => {
                directionsService.route(request, (result, status) => {
                    if (status === 'OK') {
                        currentRoute = result;
                        // Don't show the route immediately - wait for navigation to start
                        
                        const route = result.routes[0];
                        const leg = route.legs[0];
                        
                        updateStatus(`Route: ${leg.distance.text}, ${leg.duration.text}`);
                        document.getElementById('nav-button').disabled = false;
                        
                        resolve(result);
                    } else {
                        console.error('Google Directions failed, using test route:', status);
                        // Fallback to test route if Google API fails
                        createTestRoute().then(resolve).catch(reject);
                    }
                });
            });
        }

        // Handle location updates
        function handleLocationUpdate(lat, lng) {
            const newLocation = { lat: lat, lng: lng };
            userLocation = newLocation;
            
            updateUserMarker();
            
            if (isNavigating) {
                map.panTo(userLocation);
                if (currentRoute) {
                    checkNavigationProgress();
                }
            }
        }

        // Apple Maps style location dot (no white center dot)
        function updateUserMarker() {
            if (userMarker) {
                userMarker.setMap(null);
            }
            
            userMarker = new google.maps.Marker({
                position: userLocation,
                map: map,
                title: "Your Location",
                icon: {
                    url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                        <svg width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="12" cy="12" r="11" fill="white" stroke="rgba(0,0,0,0.1)" stroke-width="1"/>
                            <circle cx="12" cy="12" r="8" fill="#007AFF"/>
                        </svg>
                    `),
                    scaledSize: new google.maps.Size(24, 24),
                    anchor: new google.maps.Point(12, 12)
                }
            });
        }

        // Start navigation
        function startInAppNavigation() {
            if (!currentRoute) {
                updateStatus("No route available");
                return;
            }

            isNavigating = true;
            currentStepIndex = 0;
            
            document.getElementById('controls').style.display = 'none';
            document.getElementById('navigation-panel').style.display = 'block';
            
            // Show the route polyline during navigation
            directionsRenderer.setDirections(currentRoute);
            
            if (userLocation) {
                map.setCenter(userLocation);
                map.setZoom(18);
            }
            
            updateNavigationPanel();
        }

        // Check navigation progress
        function checkNavigationProgress() {
            if (!currentRoute || !isNavigating || !userLocation) return;
            
            const steps = currentRoute.routes[0].legs[0].steps;
            if (currentStepIndex >= steps.length) return;
            
            const currentStep = steps[currentStepIndex];
            const stepEndLocation = currentStep.end_location;
            
            let stepEndLat, stepEndLng;
            if (typeof stepEndLocation.lat === 'function') {
                stepEndLat = stepEndLocation.lat();
                stepEndLng = stepEndLocation.lng();
            } else {
                stepEndLat = stepEndLocation.lat;
                stepEndLng = stepEndLocation.lng;
            }
            
            const distance = calculateDistance(
                userLocation.lat, userLocation.lng,
                stepEndLat, stepEndLng
            );
            
            if (distance < 0.03) { // 30 meters
                currentStepIndex++;
                updateNavigationPanel();
            }
        }

        // Update navigation panel
        function updateNavigationPanel() {
            if (!currentRoute || !isNavigating) return;
            
            const steps = currentRoute.routes[0].legs[0].steps;
            
            if (currentStopIndex >= tourStops.length) {
                document.getElementById('current-instruction').textContent = "ðŸŽ‰ Tour Complete!";
                document.getElementById('distance-time').textContent = "All destinations reached";
                document.getElementById('next-instruction').textContent = "Thank you for taking the tour!";
                return;
            }
            
            if (currentStepIndex >= steps.length) {
                document.getElementById('current-instruction').textContent = "ðŸŽ‰ You have arrived!";
                document.getElementById('distance-time').textContent = `Stop ${currentStopIndex + 1}/${tourStops.length} reached`;
                document.getElementById('next-instruction').textContent = `Destination: ${tourStops[currentStopIndex].name}`;
                return;
            }
            
            const currentStep = steps[currentStepIndex];
            const nextStep = currentStepIndex + 1 < steps.length ? steps[currentStepIndex + 1] : null;
            
            const instruction = currentStep.instructions.replace(/<[^>]*>/g, '');
            document.getElementById('current-instruction').textContent = instruction;
            document.getElementById('step-distance').textContent = currentStep.distance.text;
            
            let remainingDuration = 0;
            for (let i = currentStepIndex; i < steps.length; i++) {
                remainingDuration += steps[i].duration.value;
            }
            
            const remainingTimeMinutes = Math.ceil(remainingDuration / 60);
            document.getElementById('total-remaining').textContent = `${remainingTimeMinutes} min remaining`;
            
            if (nextStep) {
                const nextInstruction = nextStep.instructions.replace(/<[^>]*>/g, '');
                document.getElementById('next-instruction').textContent = `Then: ${nextInstruction}`;
            } else {
                document.getElementById('next-instruction').textContent = `Then: Arrive at ${tourStops[currentStopIndex].name}`;
            }
        }

        // Stop navigation
        function stopNavigation() {
            isNavigating = false;
            currentStepIndex = 0;
            
            document.getElementById('navigation-panel').style.display = 'none';
            document.getElementById('controls').style.display = 'block';
            document.getElementById('nav-button').disabled = false;
            
            // Hide the route polyline when navigation stops
            directionsRenderer.setDirections({routes: []});
            
            if (userLocation) {
                map.setZoom(14);
            }
            
            updateStatus("Navigation ended");
        }

        function updateStatus(message) {
            document.getElementById('status').textContent = message;
        }

        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
    </script>

    <!-- Google Maps API -->
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDDdD8BAz34j_0zv-G3qJKTP5sKQn7PQ1w&callback=initMap">
    </script>
</body>
</html>
